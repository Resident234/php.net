# session_decode




<div class="phpcode"><span class="html">
I noticed that the posted solutions for manually decoding sessions are not perfect, so I&apos;ve contributed a more robust solution.<br><br>The preg_match solution can never work. It&apos;s not so hard to find a case that might break unserialization.<br>In the case of jason-joeymail is breaks on:<br><br><span class="default">&lt;?php<br>$_SESSION</span><span class="keyword">[</span><span class="string">&quot;test&quot;</span><span class="keyword">] = </span><span class="string">&quot;;oops|&quot;</span><span class="keyword">;<br></span><span class="default">?&gt;<br></span><br>Below you can find my solution. It doesn&apos;t use a regular expression but rather the reversibility of the serialize operation and the &apos;feature&apos; that serialize ignores all further input when it thinks it&apos;s done. It&apos;s by no means a beautiful or particularly fast solution but it is a more robust solution.<br>I&apos;ve added a deserializer for &quot;php&quot; and &quot;php_binary&quot;. It should be trivial to add one for &quot;wddx&quot;.<br><br><span class="default">&lt;?php<br></span><span class="keyword">class </span><span class="default">Session </span><span class="keyword">{<br>&#xA0; &#xA0; public static function </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$method </span><span class="keyword">= </span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">&quot;session.serialize_handler&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; switch (</span><span class="default">$method</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="string">&quot;php&quot;</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">self</span><span class="keyword">::</span><span class="default">unserialize_php</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="string">&quot;php_binary&quot;</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">self</span><span class="keyword">::</span><span class="default">unserialize_phpbinary</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; default:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">&quot;Unsupported session.serialize_handler: &quot; </span><span class="keyword">. </span><span class="default">$method </span><span class="keyword">. </span><span class="string">&quot;. Supported: php, php_binary&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; private static function </span><span class="default">unserialize_php</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$return_data </span><span class="keyword">= array();<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; while (</span><span class="default">$offset </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; if (!</span><span class="default">strstr</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">), </span><span class="string">&quot;|&quot;</span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">&quot;invalid data, remaining: &quot; </span><span class="keyword">. </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">));<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$pos </span><span class="keyword">= </span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="string">&quot;|&quot;</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$num </span><span class="keyword">= </span><span class="default">$pos </span><span class="keyword">- </span><span class="default">$offset</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$varname </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">, </span><span class="default">$num</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">+= </span><span class="default">$num </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">));<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$return_data</span><span class="keyword">[</span><span class="default">$varname</span><span class="keyword">] = </span><span class="default">$data</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">+= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">serialize</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">));<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">$return_data</span><span class="keyword">;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; private static function </span><span class="default">unserialize_phpbinary</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$return_data </span><span class="keyword">= array();<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; while (</span><span class="default">$offset </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$num </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">[</span><span class="default">$offset</span><span class="keyword">]);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$varname </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">, </span><span class="default">$num</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">+= </span><span class="default">$num</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$session_data</span><span class="keyword">, </span><span class="default">$offset</span><span class="keyword">));<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$return_data</span><span class="keyword">[</span><span class="default">$varname</span><span class="keyword">] = </span><span class="default">$data</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$offset </span><span class="keyword">+= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">serialize</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">));<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">$return_data</span><span class="keyword">;<br>&#xA0; &#xA0; }<br>}<br></span><span class="default">?&gt;<br></span><br>Usage:<br><br><span class="default">&lt;?php<br>Session</span><span class="keyword">::</span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">session_encode</span><span class="keyword">());<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
I found this to be the simplest solution:<br><br><span class="default">&lt;?php<br></span><span class="comment">// if session is not started<br></span><span class="default">session_start</span><span class="keyword">();<br><br></span><span class="comment">// store our current session<br></span><span class="default">$my_sess </span><span class="keyword">= </span><span class="default">$_SESSION</span><span class="keyword">;<br><br></span><span class="comment">// decode $data (the encoded session data, either from a file or database). Remember, decoded data is put directly into $_SESSION<br></span><span class="default">session_decode</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br></span><span class="default">$data </span><span class="keyword">= </span><span class="default">$_SESSION</span><span class="keyword">;<br><br></span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br><br></span><span class="comment">// restore our own session<br></span><span class="default">$_SESSION </span><span class="keyword">= </span><span class="default">$my_sess</span><span class="keyword">;<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/function.session-decode.php)

**[⬆ to root](/)**