# Pattern Modifiers




<div class="phpcode"><span class="html">
Regarding the validity of a UTF-8 string when using the /u pattern modifier, some things to be aware of;<br><br>1. If the pattern itself contains an invalid UTF-8 character, you get an error (as mentioned in the docs above - &quot;UTF-8 validity of the pattern is checked since PHP 4.3.5&quot;<br><br>2. When the subject string contains invalid UTF-8 sequences / codepoints, it basically result in a &quot;quiet death&quot; for the preg_* functions, where nothing is matched but without indication that the string is invalid UTF-8<br><br>3. PCRE regards five and six octet UTF-8 character sequences as valid (both in patterns and the subject string) but these are not supported in Unicode ( see section 5.9 &quot;Character Encoding&quot; of the &quot;Secure Programming for Linux and Unix HOWTO&quot; - can be found at <a href="http://www.tldp.org/" rel="nofollow" target="_blank">http://www.tldp.org/</a> and other places )<br><br>4. For an example algorithm in PHP which tests the validity of a UTF-8 string (and discards five / six octet sequences) head to: <a href="http://hsivonen.iki.fi/php-utf8/" rel="nofollow" target="_blank">http://hsivonen.iki.fi/php-utf8/</a><br><br>The following script should give you an idea of what works and what doesn&apos;t;<br><br><span class="default">&lt;?php<br>$examples </span><span class="keyword">= array(<br>&#xA0; &#xA0; </span><span class="string">&apos;Valid ASCII&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;a&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Valid 2 Octet Sequence&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xc3\xb1&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid 2 Octet Sequence&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xc3\x28&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid Sequence Identifier&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xa0\xa1&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Valid 3 Octet Sequence&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xe2\x82\xa1&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid 3 Octet Sequence (in 2nd Octet)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xe2\x28\xa1&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid 3 Octet Sequence (in 3rd Octet)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xe2\x82\x28&quot;</span><span class="keyword">,<br><br>&#xA0; &#xA0; </span><span class="string">&apos;Valid 4 Octet Sequence&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xf0\x90\x8c\xbc&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid 4 Octet Sequence (in 2nd Octet)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xf0\x28\x8c\xbc&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid 4 Octet Sequence (in 3rd Octet)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xf0\x90\x28\xbc&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Invalid 4 Octet Sequence (in 4th Octet)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xf0\x28\x8c\x28&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Valid 5 Octet Sequence (but not Unicode!)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xf8\xa1\xa1\xa1\xa1&quot;</span><span class="keyword">,<br>&#xA0; &#xA0; </span><span class="string">&apos;Valid 6 Octet Sequence (but not Unicode!)&apos; </span><span class="keyword">=&gt; </span><span class="string">&quot;\xfc\xa1\xa1\xa1\xa1\xa1&quot;</span><span class="keyword">,<br>);<br><br>echo </span><span class="string">&quot;++Invalid UTF-8 in pattern\n&quot;</span><span class="keyword">;<br>foreach ( </span><span class="default">$examples </span><span class="keyword">as </span><span class="default">$name </span><span class="keyword">=&gt; </span><span class="default">$str </span><span class="keyword">) {<br>&#xA0; &#xA0; echo </span><span class="string">&quot;</span><span class="default">$name</span><span class="string">\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">&quot;/&quot;</span><span class="keyword">.</span><span class="default">$str</span><span class="keyword">.</span><span class="string">&quot;/u&quot;</span><span class="keyword">,</span><span class="string">&apos;Testing&apos;</span><span class="keyword">);<br>}<br><br>echo </span><span class="string">&quot;++ preg_match() examples\n&quot;</span><span class="keyword">;<br>foreach ( </span><span class="default">$examples </span><span class="keyword">as </span><span class="default">$name </span><span class="keyword">=&gt; </span><span class="default">$str </span><span class="keyword">) {<br>&#xA0; &#xA0; <br>&#xA0; &#xA0; </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">&quot;/\xf8\xa1\xa1\xa1\xa1/u&quot;</span><span class="keyword">, </span><span class="default">$str</span><span class="keyword">, </span><span class="default">$ar</span><span class="keyword">);<br>&#xA0; &#xA0; echo </span><span class="string">&quot;</span><span class="default">$name</span><span class="string">: &quot;</span><span class="keyword">;<br><br>&#xA0; &#xA0; if ( </span><span class="default">count</span><span class="keyword">(</span><span class="default">$ar</span><span class="keyword">) == </span><span class="default">0 </span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&quot;Matched nothing!\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&quot;Matched </span><span class="keyword">{</span><span class="default">$ar</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]}</span><span class="string">\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; <br>}<br><br>echo </span><span class="string">&quot;++ preg_match_all() examples\n&quot;</span><span class="keyword">;<br>foreach ( </span><span class="default">$examples </span><span class="keyword">as </span><span class="default">$name </span><span class="keyword">=&gt; </span><span class="default">$str </span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="default">preg_match_all</span><span class="keyword">(</span><span class="string">&apos;/./u&apos;</span><span class="keyword">, </span><span class="default">$str</span><span class="keyword">, </span><span class="default">$ar</span><span class="keyword">);<br>&#xA0; &#xA0; echo </span><span class="string">&quot;</span><span class="default">$name</span><span class="string">: &quot;</span><span class="keyword">;<br>&#xA0; &#xA0; <br>&#xA0; &#xA0; </span><span class="default">$num_utf8_chars </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$ar</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br>&#xA0; &#xA0; if ( </span><span class="default">$num_utf8_chars </span><span class="keyword">== </span><span class="default">0 </span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&quot;Matched nothing!\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&quot;Matched </span><span class="default">$num_utf8_chars</span><span class="string"> character\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; <br>}<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
The description of the &quot;u&quot; flag is a bit misleading. It suggests that it is only required if the pattern contains UTF-8 characters, when in fact it is required if either the pattern or the subject contain UTF-8. Without it, I was having problems with preg_match_all returning invalid multibyte characters when given a UTF-8 subject string.<br><br>It&apos;s fairly clear if you read the documentation for libpcre:<br><br>&#xA0; &#xA0; &#xA0;&#xA0; In&#xA0; order&#xA0; process&#xA0; UTF-8 strings, you must build PCRE to include UTF-8<br>&#xA0; &#xA0; &#xA0;&#xA0; support in the code, and, in addition,&#xA0; you&#xA0; must&#xA0; call&#xA0; pcre_compile()<br>&#xA0; &#xA0; &#xA0;&#xA0; with&#xA0; the&#xA0; PCRE_UTF8&#xA0; option&#xA0; flag,&#xA0; or the pattern must start with the<br>&#xA0; &#xA0; &#xA0;&#xA0; sequence (*UTF8). When either of these is the case,&#xA0; both&#xA0; the&#xA0; pattern<br>&#xA0; &#xA0; &#xA0;&#xA0; and&#xA0; any&#xA0; subject&#xA0; strings&#xA0; that&#xA0; are matched against it are treated as<br>&#xA0; &#xA0; &#xA0;&#xA0; UTF-8 strings instead of strings of 1-byte characters.<br><br>[from <a href="http://www.pcre.org/pcre.txt]" rel="nofollow" target="_blank">http://www.pcre.org/pcre.txt]</a></span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/reference.pcre.pattern.modifiers.php)

**[â¬† to root](/)**