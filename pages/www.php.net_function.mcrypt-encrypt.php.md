# mcrypt_encrypt




<div class="phpcode"><span class="html">
If you&apos;re writing code to encrypt/encrypt data in 2015, you should use openssl_encrypt() and openssl_decrypt(). The underlying library (libmcrypt) has been abandoned since 2007, and performs far worse than OpenSSL (which leverages AES-NI on modern processors and is cache-timing safe).<br><br>Also, MCRYPT_RIJNDAEL_256 is not AES-256, it&apos;s a different variant of the Rijndael block cipher. If you want AES-256 in mcrypt, you have to use MCRYPT_RIJNDAEL_128 with a 32-byte key. OpenSSL makes it more obvious which mode you are using (i.e. &apos;aes-128-cbc&apos; vs &apos;aes-256-ctr&apos;).<br><br>OpenSSL also uses PKCS7 padding with CBC mode rather than mcrypt&apos;s NULL byte padding. Thus, mcrypt is more likely to make your code vulnerable to padding oracle attacks than OpenSSL.<br><br>Finally, if you are not authenticating your ciphertexts (Encrypt Then MAC), you&apos;re doing it wrong.<br><br>Further reading:<br><br><a href="https://paragonie.com/blog/2015/05/using-encryption-and-authentication-correctly" rel="nofollow" target="_blank">https://paragonie.com/blog/2015/05/using-encryption-and-authentication-correctly</a><br><br><a href="https://paragonie.com/blog/2015/05/if-you-re-typing-word-mcrypt-into-your-code-you-re-doing-it-wrong" rel="nofollow" target="_blank">https://paragonie.com/blog/2015/05/if-you-re-typing-word-mcrypt-into-your-code-you-re-doing-it-wrong</a></span>
</div>
  

#


<div class="phpcode"><span class="html">
Solving 3DES incompatibilities with .NET&apos;s TripleDESCryptoServiceProvider<br><br>mcrypt&apos;s 3DES only accepts 192 bit keys, but Microsoft&apos;s .NET and many other tools accept both 128 and 192 bit keys.<br>If your key is too short, mcrypt will &apos;helpfully&apos; pad null characters onto the end, but .NET refuses to use a key where the last third is all null (this is a Bad Key). This prevents you from emulating mcrypt&apos;s &quot;short key&quot; behaviour in .NET.<br><br>How to reconcile this? A little DES theory is in order<br>3DES runs the DES algorithm three times, using each third of your 192 bit key as the 64 bit DES key<br><br>Encrypt Key1 -&gt; Decrypt Key2 -&gt; Encrypt Key3<br><br>and both .NET and PHP&apos;s mcrypt do this the same way.<br>The problem arises in short key mode on .NET, since 128 bits is only two 64 bit DES keys<br>The algorithm that they use then is:<br><br>Encrypt Key1 -&gt; Decrypt Key2 -&gt; Encrypt Key1<br><br>mcrypt does not have this mode of operation natively.<br>but before you go and start running DES three times yourself, here&apos;s a Quick Fix<br><span class="default">&lt;?php<br>$my_key </span><span class="keyword">= </span><span class="string">&quot;12345678abcdefgh&quot;</span><span class="keyword">; </span><span class="comment">// a 128 bit (16 byte) key<br></span><span class="default">$my_key </span><span class="keyword">.= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$my_key</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">8</span><span class="keyword">); </span><span class="comment">// append the first 8 bytes onto the end<br></span><span class="default">$secret </span><span class="keyword">= </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">MCRYPT_3DES</span><span class="keyword">, </span><span class="default">$my_key</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);&#xA0; </span><span class="comment">//CBC is the default mode in .NET<br></span><span class="default">?&gt;<br></span><br>And, like magic, it works.<br><br>There&apos;s one more caveat: Data padding<br>mcrypt always pads data will the null character<br>but .NET has two padding modes: &quot;Zeros&quot; and &quot;PKCS7&quot;<br>Zeros is identical to the mcrypt scheme, but PKCS7 is the default.<br>PKCS7 isn&apos;t much more complex, though:<br>instead of nulls, it appends the total number of padding bytes (which means, for 3DES, it can be a value from 0x01 to 0x07)<br>if your plaintext is &quot;ABC&quot;, it will be padded into:<br>0x41 0x42 0x43 0x05 0x05 0x05 0x05 0x05<br><br>You can remove these from a decrypted string in PHP by counting the number of times that last character appears, and if it matches it&apos;s ordinal value, truncating the string by that many characters:<br><span class="default">&lt;?php<br>&#xA0; &#xA0; $block </span><span class="keyword">= </span><span class="default">mcrypt_get_block_size</span><span class="keyword">(</span><span class="string">&apos;tripledes&apos;</span><span class="keyword">, </span><span class="string">&apos;cbc&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$packing </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">{</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">});<br>&#xA0; &#xA0; if(</span><span class="default">$packing </span><span class="keyword">and (</span><span class="default">$packing </span><span class="keyword">&lt; </span><span class="default">$block</span><span class="keyword">)){<br>&#xA0; &#xA0; &#xA0; for(</span><span class="default">$P </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">; </span><span class="default">$P </span><span class="keyword">&gt;= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) - </span><span class="default">$packing</span><span class="keyword">; </span><span class="default">$P</span><span class="keyword">--){<br>&#xA0; &#xA0; if(</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">{</span><span class="default">$P</span><span class="keyword">}) != </span><span class="default">$packing</span><span class="keyword">){<br>&#xA0; &#xA0; &#xA0; </span><span class="default">$packing </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; </span><span class="default">$text </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">) - </span><span class="default">$packing</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>And to pad a string that you intend to decrypt with .NET, just add the chr() value of the number of padding bytes:<br><span class="default">&lt;?php<br>&#xA0; &#xA0; $block </span><span class="keyword">= </span><span class="default">mcrypt_get_block_size</span><span class="keyword">(</span><span class="string">&apos;tripledes&apos;</span><span class="keyword">, </span><span class="string">&apos;cbc&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$dat</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$padding </span><span class="keyword">= </span><span class="default">$block </span><span class="keyword">- (</span><span class="default">$len </span><span class="keyword">% </span><span class="default">$block</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$dat </span><span class="keyword">.= </span><span class="default">str_repeat</span><span class="keyword">(</span><span class="default">chr</span><span class="keyword">(</span><span class="default">$padding</span><span class="keyword">),</span><span class="default">$padding</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>That&apos;s all there is to it.<br>Knowing this, you can encrypt, decrypt, and duplicate exactly any .NET 3DES behaviour in PHP.</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/function.mcrypt-encrypt.php)

**[To root](/README.md)**