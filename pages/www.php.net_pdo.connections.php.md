# Connections and Connection management




<div class="phpcode"><span class="html">
Using PHP 5.4.26, pdo_pgsql with libpg 9.2.8 (self compiled). As usual PHP never explains some critical stuff in documentation. You shouldn&apos;t expect that your connection is closed when you set $dbh = null unless all you do is just instantiating PDO class. Try following:<br><br><span class="default">&lt;?php<br>$pdo </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;pgsql:host=192.168.137.1;port=5432;dbname=anydb&apos;</span><span class="keyword">, </span><span class="string">&apos;anyuser&apos;</span><span class="keyword">, </span><span class="string">&apos;pw&apos;</span><span class="keyword">);<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br></span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&apos;SELECT * FROM sometable&apos;</span><span class="keyword">);<br></span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br></span><span class="default">$pdo </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">60</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>Now check your database. And what a surprise! Your connection hangs for another 60 seconds. Now that might be expectable because you haven&apos;t cleared the resultset.<br><br><span class="default">&lt;?php<br>$pdo </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;pgsql:host=192.168.137.160;port=5432;dbname=platin&apos;</span><span class="keyword">, </span><span class="string">&apos;cappytoi&apos;</span><span class="keyword">, </span><span class="string">&apos;1111&apos;</span><span class="keyword">);<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br></span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&apos;SELECT * FROM admin&apos;</span><span class="keyword">);<br></span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br></span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">closeCursor</span><span class="keyword">();<br></span><span class="default">$pdo </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">60</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>What teh heck you say at this point? Still same? Here is what you need to do to close that connection:<br><br><span class="default">&lt;?php<br>$pdo </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;pgsql:host=192.168.137.160;port=5432;dbname=platin&apos;</span><span class="keyword">, </span><span class="string">&apos;cappytoi&apos;</span><span class="keyword">, </span><span class="string">&apos;1111&apos;</span><span class="keyword">);<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br></span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&apos;SELECT * FROM admin&apos;</span><span class="keyword">);<br></span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br></span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">closeCursor</span><span class="keyword">(); </span><span class="comment">// this is not even required<br></span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">; </span><span class="comment">// doing this is mandatory for connection to get closed<br></span><span class="default">$pdo </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">60</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>PDO is just one of a kind because it saves you to depend on 3rd party abstraction layers. But it becomes annoying to see there is no implementation of a &quot;disconnect&quot; method even though there is a request for it for 2 years. Developers underestimate the requirement of such a method. First of all, doing $stmt = null&#xA0; everywhere is annoying and what is most annoying is you cannot forcibly disconnect even when you set $pdo = null. It might get cleared on script&apos;s termination but this is not always possible because script termination may delayed due to slow client connection etc.<br><br>Anyway here is how to disconnect forcibly using postgresql:<br><br><span class="default">&lt;?php<br>$pdo </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;pgsql:host=192.168.137.160;port=5432;dbname=platin&apos;</span><span class="keyword">, </span><span class="string">&apos;cappytoi&apos;</span><span class="keyword">, </span><span class="string">&apos;1111&apos;</span><span class="keyword">);<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br></span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&apos;SELECT * FROM admin&apos;</span><span class="keyword">);<br></span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br></span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">&apos;SELECT pg_terminate_backend(pg_backend_pid());&apos;</span><span class="keyword">);<br></span><span class="default">$pdo </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">60</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>Following may be used for MYSQL: (not guaranteed)<br>KILL CONNECTION_ID()</span>
</div>
  

#


<div class="phpcode"><span class="html">
I would please advice people who talk about database port in reference with socket files to please read up about what a socket file is. TCP/IP uses ports, a socket file however is a direct pipe line to your database. So no, you should not replace localhost with local ip if you use a different port on your database server, because the socket file has nothing to do with your TCP/IP setup. And whenever possible, using the local socket file is much faster than establishing new TCP/IP connections on each request which is only meant for remote database servers.</span>
</div>
  

#


<div class="phpcode"><span class="html">
Just thought I&apos;d add in and give an explanation as to why you need to use 127.0.0.1 if you have a different port number.<br><br>The mysql libraries will automatically use Unix sockets if the host of &quot;localhost&quot; is used. To force TCP/IP you need to set an IP address.</span>
</div>
  

#


<div class="phpcode"><span class="html">
As <a href="http://stackoverflow.com/questions/17630772/pdo-cannot-connect-remote-mysql-server" rel="nofollow" target="_blank">http://stackoverflow.com/questions/17630772/pdo-cannot-connect-remote-mysql-server</a> points out; sometimes when you want to connect to an external server like this:<br><br><span class="default">&lt;?php<br>$conn </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;mysql:host=123.4.5.6;dbname=test_db;port=3306&apos;</span><span class="keyword">,</span><span class="string">&apos;username&apos;</span><span class="keyword">,</span><span class="string">&apos;password&apos;</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>it will fail no matter what. However if you put a space between mysql: and host like this:<br><br><span class="default">&lt;?php<br>$conn </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;mysql: host=123.4.5.6;dbname=test_db;port=3306&apos;</span><span class="keyword">,</span><span class="string">&apos;username&apos;</span><span class="keyword">,</span><span class="string">&apos;password&apos;</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>it will magically work. I&apos;m not sure if this applies in all cases or server setups. But I think it&apos;s worth mentioning in the docs.</span>
</div>
  

#


<div class="phpcode"><span class="html">
To avoid exposing your connection details should you fail to remember to catch any exception thrown by the PDO constructor you can use the following class to implicitly change the exception handler temporarily.<br><br><span class="default">&lt;?php<br><br></span><span class="keyword">Class </span><span class="default">SafePDO </span><span class="keyword">extends </span><span class="default">PDO </span><span class="keyword">{<br> <br>&#xA0; &#xA0; &#xA0; &#xA0; public static function </span><span class="default">exception_handler</span><span class="keyword">(</span><span class="default">$exception</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// Output the exception details<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="keyword">die(</span><span class="string">&apos;Uncaught exception: &apos;</span><span class="keyword">, </span><span class="default">$exception</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">());<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br> <br>&#xA0; &#xA0; &#xA0; &#xA0; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$dsn</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">=</span><span class="string">&apos;&apos;</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">=</span><span class="string">&apos;&apos;</span><span class="keyword">, </span><span class="default">$driver_options</span><span class="keyword">=array()) {<br><br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// Temporarily change the PHP exception handler while we . . .<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">set_exception_handler</span><span class="keyword">(array(</span><span class="default">__CLASS__</span><span class="keyword">, </span><span class="string">&apos;exception_handler&apos;</span><span class="keyword">));<br><br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// . . . create a PDO object<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">parent</span><span class="keyword">::</span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$dsn</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">, </span><span class="default">$driver_options</span><span class="keyword">);<br><br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// Change the exception handler back to whatever it was before<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">restore_exception_handler</span><span class="keyword">();<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br><br>}<br><br></span><span class="comment">// Connect to the database with defined constants<br></span><span class="default">$dbh </span><span class="keyword">= new </span><span class="default">SafePDO</span><span class="keyword">(</span><span class="default">PDO_DSN</span><span class="keyword">, </span><span class="default">PDO_USER</span><span class="keyword">, </span><span class="default">PDO_PASSWORD</span><span class="keyword">);<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/pdo.connections.php)

**[To root](/README.md)**