# imagejpeg




<div class="phpcode"><span class="html">
I didn&apos;t find any example like this on the Web, so I mixed pieces together.. hope this will save time to other people!<br><br>Here&apos;s a complete solution to READ any image (gif jpg png) from the FILESYSTEM, SCALE it to a max width/height, SAVE the scaled image to a BLOB field keeping the original image type. Quite tricky.. <br><br><span class="default">&lt;?php<br><br></span><span class="keyword">function </span><span class="default">scaleImageFileToBlob</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">) {<br><br>&#xA0; &#xA0; </span><span class="default">$source_pic </span><span class="keyword">= </span><span class="default">$file</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$max_width </span><span class="keyword">= </span><span class="default">200</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$max_height </span><span class="keyword">= </span><span class="default">200</span><span class="keyword">;<br><br>&#xA0; &#xA0; list(</span><span class="default">$width</span><span class="keyword">, </span><span class="default">$height</span><span class="keyword">, </span><span class="default">$image_type</span><span class="keyword">) = </span><span class="default">getimagesize</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);<br><br>&#xA0; &#xA0; switch (</span><span class="default">$image_type</span><span class="keyword">)<br>&#xA0; &#xA0; {<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">1</span><span class="keyword">: </span><span class="default">$src </span><span class="keyword">= </span><span class="default">imagecreatefromgif</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">); break;<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">2</span><span class="keyword">: </span><span class="default">$src </span><span class="keyword">= </span><span class="default">imagecreatefromjpeg</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);&#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">3</span><span class="keyword">: </span><span class="default">$src </span><span class="keyword">= </span><span class="default">imagecreatefrompng</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">); break;<br>&#xA0; &#xA0; &#xA0; &#xA0; default: return </span><span class="string">&apos;&apos;</span><span class="keyword">;&#xA0; break;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="default">$x_ratio </span><span class="keyword">= </span><span class="default">$max_width </span><span class="keyword">/ </span><span class="default">$width</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$y_ratio </span><span class="keyword">= </span><span class="default">$max_height </span><span class="keyword">/ </span><span class="default">$height</span><span class="keyword">;<br><br>&#xA0; &#xA0; if( (</span><span class="default">$width </span><span class="keyword">&lt;= </span><span class="default">$max_width</span><span class="keyword">) &amp;&amp; (</span><span class="default">$height </span><span class="keyword">&lt;= </span><span class="default">$max_height</span><span class="keyword">) ){<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tn_width </span><span class="keyword">= </span><span class="default">$width</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tn_height </span><span class="keyword">= </span><span class="default">$height</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; }elseif ((</span><span class="default">$x_ratio </span><span class="keyword">* </span><span class="default">$height</span><span class="keyword">) &lt; </span><span class="default">$max_height</span><span class="keyword">){<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tn_height </span><span class="keyword">= </span><span class="default">ceil</span><span class="keyword">(</span><span class="default">$x_ratio </span><span class="keyword">* </span><span class="default">$height</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tn_width </span><span class="keyword">= </span><span class="default">$max_width</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; }else{<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tn_width </span><span class="keyword">= </span><span class="default">ceil</span><span class="keyword">(</span><span class="default">$y_ratio </span><span class="keyword">* </span><span class="default">$width</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tn_height </span><span class="keyword">= </span><span class="default">$max_height</span><span class="keyword">;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">imagecreatetruecolor</span><span class="keyword">(</span><span class="default">$tn_width</span><span class="keyword">,</span><span class="default">$tn_height</span><span class="keyword">);<br><br>&#xA0; &#xA0; </span><span class="comment">/* Check if this image is PNG or GIF, then set if Transparent*/<br>&#xA0; &#xA0; </span><span class="keyword">if((</span><span class="default">$image_type </span><span class="keyword">== </span><span class="default">1</span><span class="keyword">) OR (</span><span class="default">$image_type</span><span class="keyword">==</span><span class="default">3</span><span class="keyword">))<br>&#xA0; &#xA0; {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">imagealphablending</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">imagesavealpha</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">,</span><span class="default">true</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$transparent </span><span class="keyword">= </span><span class="default">imagecolorallocatealpha</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">, </span><span class="default">127</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">imagefilledrectangle</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$tn_width</span><span class="keyword">, </span><span class="default">$tn_height</span><span class="keyword">, </span><span class="default">$transparent</span><span class="keyword">);<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; </span><span class="default">imagecopyresampled</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">,</span><span class="default">$src</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$tn_width</span><span class="keyword">, </span><span class="default">$tn_height</span><span class="keyword">,</span><span class="default">$width</span><span class="keyword">,</span><span class="default">$height</span><span class="keyword">);<br><br>&#xA0; &#xA0; </span><span class="comment">/*<br>&#xA0; &#xA0;&#xA0; * imageXXX() only has two options, save as a file, or send to the browser.<br>&#xA0; &#xA0;&#xA0; * It does not provide you the oppurtunity to manipulate the final GIF/JPG/PNG file stream<br>&#xA0; &#xA0;&#xA0; * So I start the output buffering, use imageXXX() to output the data stream to the browser, <br>&#xA0; &#xA0;&#xA0; * get the contents of the stream, and use clean to silently discard the buffered contents.<br>&#xA0; &#xA0;&#xA0; */<br>&#xA0; &#xA0; </span><span class="default">ob_start</span><span class="keyword">();<br><br>&#xA0; &#xA0; switch (</span><span class="default">$image_type</span><span class="keyword">)<br>&#xA0; &#xA0; {<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">1</span><span class="keyword">: </span><span class="default">imagegif</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">); break;<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">2</span><span class="keyword">: </span><span class="default">imagejpeg</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);&#xA0; break; </span><span class="comment">// best quality<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="keyword">case </span><span class="default">3</span><span class="keyword">: </span><span class="default">imagepng</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">, </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">); break; </span><span class="comment">// no compression<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="keyword">default: echo </span><span class="string">&apos;&apos;</span><span class="keyword">; break;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="default">$final_image </span><span class="keyword">= </span><span class="default">ob_get_contents</span><span class="keyword">();<br><br>&#xA0; &#xA0; </span><span class="default">ob_end_clean</span><span class="keyword">();<br><br>&#xA0; &#xA0; return </span><span class="default">$final_image</span><span class="keyword">;<br>}<br><br></span><span class="default">?&gt;<br></span><br>So, let&apos;s suppose you have a form where a user can upload an image, and you have to scale it and save it into your database.<br><br><span class="default">&lt;?php<br>&#xA0; &#xA0; <br>&#xA0; &#xA0; </span><span class="keyword">[..] </span><span class="comment">// the user has clicked the Submit button..<br>&#xA0; &#xA0; <br>&#xA0; &#xA0; // Check if the user entered an image<br>&#xA0; &#xA0; </span><span class="keyword">if (</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;imagefile&apos;</span><span class="keyword">][</span><span class="string">&apos;name&apos;</span><span class="keyword">] != </span><span class="string">&apos;&apos;</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">scaleImageFileToBlob</span><span class="keyword">(</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;imagefile&apos;</span><span class="keyword">][</span><span class="string">&apos;tmp_name&apos;</span><span class="keyword">]);<br><br>&#xA0; &#xA0; &#xA0; &#xA0; if (</span><span class="default">$image </span><span class="keyword">== </span><span class="string">&apos;&apos;</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&apos;Image type not supported&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$image_type </span><span class="keyword">= </span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;imagefile&apos;</span><span class="keyword">][</span><span class="string">&apos;type&apos;</span><span class="keyword">];<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$image </span><span class="keyword">= </span><span class="default">addslashes</span><span class="keyword">(</span><span class="default">$image</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$query&#xA0; </span><span class="keyword">= </span><span class="string">&quot;UPDATE yourtable SET image_type=&apos;</span><span class="default">$image_type</span><span class="string">&apos;, image=&apos;</span><span class="default">$image</span><span class="string">&apos; WHERE ...&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; if (</span><span class="default">$result</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; echo </span><span class="string">&apos;Image scaled and uploaded&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; echo </span><span class="string">&apos;Error running the query&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; }<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
If string $filename is given and it exists, it will be overwritten.</span>
</div>
  

#


<div class="phpcode"><span class="html">
[[Editor&apos;s note: removed the header()-call since it is not required when outputting inline image-data]]
<br>One single code line, solve-me after 3 hours of blind search!
<br>
<br>here is:
<br>
<br>... ob_start();
<br>&#xA0; imagejpeg( $img, NULL, 100 );
<br>&#xA0; imagedestroy( $img );
<br>&#xA0; $i = ob_get_clean();
<br>
<br>echo &quot;&lt;img src=&apos;data:image/jpeg;base64,&quot; . base64_encode( $i ).&quot;&apos;&gt;&quot;; //saviour line!</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/function.imagejpeg.php)

**[To root](/README.md)**