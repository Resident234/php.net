# htmlentities




<div class="phpcode"><span class="html">
An important note below about using this function to secure your application against Cross Site Scripting (XSS) vulnerabilities.<br><br>When printing user input in an attribute of an HTML tag, the default configuration of htmlEntities() doesn&apos;t protect you against XSS, when using single quotes to define the border of the tag&apos;s attribute-value. XSS is then possible by injecting a single quote:<br><br><span class="default">&lt;?php<br>$_GET</span><span class="keyword">[</span><span class="string">&apos;a&apos;</span><span class="keyword">] = </span><span class="string">&quot;#000&apos; onload=&apos;alert(document.cookie)&quot;</span><span class="keyword">;<br></span><span class="default">?&gt;<br></span><br>XSS possible (insecure):<br><br><span class="default">&lt;?php<br>$href </span><span class="keyword">= </span><span class="default">htmlEntities</span><span class="keyword">(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">&apos;a&apos;</span><span class="keyword">]);<br>print </span><span class="string">&quot;&lt;body bgcolor=&apos;</span><span class="default">$href</span><span class="string">&apos;&gt;&quot;</span><span class="keyword">; </span><span class="comment"># results in: &lt;body bgcolor=&apos;#000&apos; onload=&apos;alert(document.cookie)&apos;&gt;<br></span><span class="default">?&gt;<br></span><br>Use the &apos;ENT_QUOTES&apos; quote style option, to ensure no XSS is possible and your application is secure:<br><br><span class="default">&lt;?php<br>$href </span><span class="keyword">= </span><span class="default">htmlEntities</span><span class="keyword">(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">&apos;a&apos;</span><span class="keyword">], </span><span class="default">ENT_QUOTES</span><span class="keyword">);<br>print </span><span class="string">&quot;&lt;body bgcolor=&apos;</span><span class="default">$href</span><span class="string">&apos;&gt;&quot;</span><span class="keyword">; </span><span class="comment"># results in: &lt;body bgcolor=&apos;#000&amp;#039; onload=&amp;#039;alert(document.cookie)&apos;&gt;<br></span><span class="default">?&gt;<br></span><br>The &apos;ENT_QUOTES&apos; option doesn&apos;t protect you against javascript evaluation in certain tag&apos;s attributes, like the &apos;href&apos; attribute of the &apos;a&apos; tag. When clicked on the link below, the given JavaScript will get executed:<br><br><span class="default">&lt;?php<br>$_GET</span><span class="keyword">[</span><span class="string">&apos;a&apos;</span><span class="keyword">] = </span><span class="string">&apos;javascript:alert(document.cookie)&apos;</span><span class="keyword">;<br></span><span class="default">$href </span><span class="keyword">= </span><span class="default">htmlEntities</span><span class="keyword">(</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">&apos;a&apos;</span><span class="keyword">], </span><span class="default">ENT_QUOTES</span><span class="keyword">);<br>print </span><span class="string">&quot;&lt;a href=&apos;</span><span class="default">$href</span><span class="string">&apos;&gt;link&lt;/a&gt;&quot;</span><span class="keyword">; </span><span class="comment"># results in: &lt;a href=&apos;javascript:alert(document.cookie)&apos;&gt;link&lt;/a&gt;<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
I&apos;ve seen lots of functions to convert all the entities, but I needed to do a fulltext search in a db field that had named entities instead of numeric entities (edited by tinymce), so I searched the tinymce source and found a string with the value-&gt;entity mapping. So, i wrote the following function to encode the user&apos;s query with named entities.<br><br>The string I used is different of the original, because i didn&apos;t want to convert &apos; or &quot;. The string is too long, so I had to cut it. To get the original check TinyMCE source and search for nbsp or other entity ;)<br><br><span class="default">&lt;?php<br><br>$entities_unmatched </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">&apos;,&apos;</span><span class="keyword">, </span><span class="string">&apos;160,nbsp,161,iexcl,162,cent, [...] &apos;</span><span class="keyword">);<br></span><span class="default">$even </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br>foreach(</span><span class="default">$entities_unmatched </span><span class="keyword">as </span><span class="default">$c</span><span class="keyword">) {<br>&#xA0; &#xA0; if(</span><span class="default">$even</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$ord </span><span class="keyword">= </span><span class="default">$c</span><span class="keyword">;<br>&#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$entities_table</span><span class="keyword">[</span><span class="default">$ord</span><span class="keyword">] = </span><span class="default">$c</span><span class="keyword">;<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; </span><span class="default">$even </span><span class="keyword">= </span><span class="default">1 </span><span class="keyword">- </span><span class="default">$even</span><span class="keyword">;<br>}<br><br>function </span><span class="default">encode_named_entities</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">) {<br>&#xA0; &#xA0; global </span><span class="default">$entities_table</span><span class="keyword">;<br>&#xA0; &#xA0; <br>&#xA0; &#xA0; </span><span class="default">$encoded_str </span><span class="keyword">= </span><span class="string">&apos;&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$ent </span><span class="keyword">= @</span><span class="default">$entities_table</span><span class="keyword">[</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">{</span><span class="default">$i</span><span class="keyword">})];<br>&#xA0; &#xA0; &#xA0; &#xA0; if(</span><span class="default">$ent</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$encoded_str </span><span class="keyword">.= </span><span class="string">&quot;&amp;</span><span class="default">$ent</span><span class="string">;&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$encoded_str </span><span class="keyword">.= </span><span class="default">$str</span><span class="keyword">{</span><span class="default">$i</span><span class="keyword">};<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; return </span><span class="default">$encoded_str</span><span class="keyword">;<br>}<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
html entities does not encode all unicode characters. It encodes what it can [all of latin1], and the others slip through. &amp;#1033; is the nasty I use. I have searched for a function which encodes everything, but in the end I wrote this. This is as simple as I can get it. Consult an ansii table to custom include/omit chars you want/don&apos;t. I&apos;m sure it&apos;s not that fast.<br><br>// Unicode-proof htmlentities. <br>// Returns &apos;normal&apos; chars as chars and weirdos as numeric html entites.<br>function superentities( $str ){<br>&#xA0; &#xA0; // get rid of existing entities else double-escape<br>&#xA0; &#xA0; $str = html_entity_decode(stripslashes($str),ENT_QUOTES,&apos;UTF-8&apos;); <br>&#xA0; &#xA0; $ar = preg_split(&apos;/(?&lt;!^)(?!$)/u&apos;, $str );&#xA0; // return array of every multi-byte character<br>&#xA0; &#xA0; foreach ($ar as $c){<br>&#xA0; &#xA0; &#xA0; &#xA0; $o = ord($c);<br>&#xA0; &#xA0; &#xA0; &#xA0; if ( (strlen($c) &gt; 1) || /* multi-byte [unicode] */<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; ($o &lt;32 || $o &gt; 126) || /* &lt;- control / latin weirdos -&gt; */<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; ($o &gt;33 &amp;&amp; $o &lt; 40) ||/* quotes + ambersand */<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; ($o &gt;59 &amp;&amp; $o &lt; 63) /* html */<br>&#xA0; &#xA0; &#xA0; &#xA0; ) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; // convert to numeric entity<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; $c = mb_encode_numericentity($c,array (0x0, 0xffff, 0, 0xffff), &apos;UTF-8&apos;);<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; $str2 .= $c;<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; return $str2;<br>}</span>
</div>
  

#


<div class="phpcode"><span class="html">
If you are building a loadvars page for Flash and have problems with special chars such as &quot; &amp; &quot;, &quot; &apos; &quot; etc, you should escape them for flash:
<br>
<br>Try trace(escape(&quot;&amp;&quot;)); in flash&apos; actionscript to see the escape code for &amp;;
<br>
<br>% = %25
<br>&amp; = %26
<br>&apos; = %27
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">flashentities</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">){
<br>return </span><span class="default">str_replace</span><span class="keyword">(array(</span><span class="string">&quot;&amp;&quot;</span><span class="keyword">,</span><span class="string">&quot;&apos;&quot;</span><span class="keyword">),array(</span><span class="string">&quot;%26&quot;</span><span class="keyword">,</span><span class="string">&quot;%27&quot;</span><span class="keyword">),</span><span class="default">$string</span><span class="keyword">);
<br>}
<br></span><span class="default">?&gt;
<br></span>
<br>Those are the two that concerned me. YMMV.</span>
</div>
  

#


<div class="phpcode"><span class="html">
The following will make a string completely safe for XML:<br><br><span class="default">&lt;?php<br></span><span class="keyword">function </span><span class="default">philsXMLClean</span><span class="keyword">(</span><span class="default">$strin</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br><br>&#xA0; &#xA0; &#xA0; &#xA0; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$strin</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$ord </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$strin</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);<br><br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; if ((</span><span class="default">$ord </span><span class="keyword">&gt; </span><span class="default">0 </span><span class="keyword">&amp;&amp; </span><span class="default">$ord </span><span class="keyword">&lt; </span><span class="default">32</span><span class="keyword">) || (</span><span class="default">$ord </span><span class="keyword">&gt;= </span><span class="default">127</span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">.= </span><span class="string">&quot;&amp;amp;#</span><span class="keyword">{</span><span class="default">$ord</span><span class="keyword">}</span><span class="string">;&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; else {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; switch (</span><span class="default">$strin</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="string">&apos;&lt;&apos;</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">.= </span><span class="string">&apos;&amp;lt;&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="string">&apos;&gt;&apos;</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">.= </span><span class="string">&apos;&amp;gt;&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="string">&apos;&amp;&apos;</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">.= </span><span class="string">&apos;&amp;amp;&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="string">&apos;&quot;&apos;</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">.= </span><span class="string">&apos;&amp;quot;&apos;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; default:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$strout </span><span class="keyword">.= </span><span class="default">$strin</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br><br>&#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">$strout</span><span class="keyword">;<br>}<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
For those Spanish (and not only) folks, that want their national letters back after htmlentities :)<br><br><span class="default">&lt;?php<br></span><span class="keyword">protected function </span><span class="default">_decodeAccented</span><span class="keyword">(</span><span class="default">$encodedValue</span><span class="keyword">, </span><span class="default">$options </span><span class="keyword">= array()) {<br>&#xA0; &#xA0; </span><span class="default">$options </span><span class="keyword">+= array(<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;quote&apos;&#xA0; &#xA0;&#xA0; </span><span class="keyword">=&gt; </span><span class="default">ENT_NOQUOTES</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;encoding&apos;&#xA0; </span><span class="keyword">=&gt; </span><span class="string">&apos;UTF-8&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; );<br>&#xA0; &#xA0; return </span><span class="default">preg_replace_callback</span><span class="keyword">(<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;/&amp;\w(acute|uml|tilde);/&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">create_function</span><span class="keyword">(<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;$m&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;return html_entity_decode($m[0], &apos; </span><span class="keyword">. </span><span class="default">$options</span><span class="keyword">[</span><span class="string">&apos;quote&apos;</span><span class="keyword">] . </span><span class="string">&apos;, &quot;&apos; </span><span class="keyword">.<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$options</span><span class="keyword">[</span><span class="string">&apos;encoding&apos;</span><span class="keyword">] . </span><span class="string">&apos;&quot;);&apos;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="keyword">),<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$encodedValue<br>&#xA0; &#xA0; </span><span class="keyword">);<br>}<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/function.htmlentities.php)

**[To root](/README.md)**