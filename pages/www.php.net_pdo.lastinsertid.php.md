# PDO::lastInsertId




<div class="phpcode"><span class="html">
Remember, if you use a transaction you should use lastInsertId BEFORE you commit<br>otherwise it will return 0</span>
</div>
  

#


<div class="phpcode"><span class="html">
To save time for some of you.<br><br>When using MySQL or MariaDB while inserting multiple rows in a single query (INSERT INTO table (a,b,c) VALUES (1,2,3), (2,3,4), ...) to a table with auto_increment column, PDO::lastInsertId does NOT return the autogenerated id of the last row. Instead, the FIRST generated id is returned. This may very well be explained by taking a look at MySQL and MariaDB&apos;s documentation.<br><br>Quotations from their respective documentations, <br><br>MySQL:<br>&quot;With no argument, LAST_INSERT_ID() returns a BIGINT UNSIGNED (64-bit) value representing the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement.&quot;<br><br>MariaDB:<br>&quot;LAST_INSERT_ID() (no arguments) returns the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement.&quot;<br><br>This is clearly not what lastInsertId&apos;s own documentation states. Hopefully this will save someone from debugging the cause of id mismatch.<br><br>tl;dr (MySQL | Mariadb) + multi row insert + PDO::lastInsertId = first autogenerated id<br><br>Behaviour tested using MariaDB 10.2.6 32-bit, PHP 5.6.31 32-bit and mysqlnd 5.0.11 running on windows 7.</span>
</div>
  

#


<div class="phpcode"><span class="html">
Sorry to contradict Jonathon Hibbard&apos;s comment (<a href="http://php.net/manual/en/pdo.lastinsertid.php#82838" rel="nofollow" target="_blank">http://php.net/manual/en/pdo.lastinsertid.php#82838</a>), but my experiencie with INSERT INTO ... ON DUPLICATE KEY UPDATE is totally different; maybe it&apos;s due to PHP version (I&apos;m on Windows, 5.4.7; I realize his post is 6 years old) or to the database engine (MySQL in my case).<br><br>Nevertheless, if I do an INSERT INTO ... ON DUPLICATE KEY UPDATE (something like id=id or equivalent, where the updated value is equal to the original one), this is what I&apos;m getting:<br><br>- If the key didn&apos;t exist, the value is inserted, and lastInsertId() returns the expected id for the new row.<br><br>- If the row exists AND a value is updated, with lastInsertId() I get the ID of the updated row.<br><br>- If the row exists but NO value is updated, lastInsertId() returns 0.<br><br>That contradicts his example, where he assures that<br>&quot;INSERT INTO city (`city`) VALUES (&apos;Paris&apos;) ON DUPLICATE KEY UPDATE `city` = &apos;Paris&apos;&quot;<br>returns 2 (??) on lastInsertId() and that he expected to return 1 &quot;since no records were inserted&quot; (??).<br><br>Hope this helps someone.</span>
</div>
  

#


<div class="phpcode"><span class="html">
Beware of lastInsertId() when working with transactions in mysql. The following code returns 0 instead of the insert id.
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">try {
<br>&#xA0; &#xA0; </span><span class="default">$dbh </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">&apos;mysql:host=localhost;dbname=test&apos;</span><span class="keyword">, </span><span class="string">&apos;username&apos;</span><span class="keyword">, </span><span class="string">&apos;password&apos;</span><span class="keyword">);
<br>
<br>&#xA0; &#xA0; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&quot;INSERT INTO test (name, email) VALUES(?,?)&quot;</span><span class="keyword">);
<br>
<br>&#xA0; &#xA0; try {
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$tmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">( array(</span><span class="string">&apos;user&apos;</span><span class="keyword">, </span><span class="string">&apos;user@example.com&apos;</span><span class="keyword">));
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">commit</span><span class="keyword">();
<br>&#xA0; &#xA0; &#xA0; &#xA0; print </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">lastInsertId</span><span class="keyword">();
<br>&#xA0; &#xA0; } catch(</span><span class="default">PDOExecption $e</span><span class="keyword">) {
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">rollback</span><span class="keyword">();
<br>&#xA0; &#xA0; &#xA0; &#xA0; print </span><span class="string">&quot;Error!: &quot; </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">&quot;&lt;/br&gt;&quot;</span><span class="keyword">;
<br>&#xA0; &#xA0; }
<br>} catch( </span><span class="default">PDOExecption $e </span><span class="keyword">) {
<br>&#xA0; &#xA0; print </span><span class="string">&quot;Error!: &quot; </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">&quot;&lt;/br&gt;&quot;</span><span class="keyword">;
<br>}
<br></span><span class="default">?&gt;
<br></span>
<br>When no exception is thrown, lastInsertId returns 0. However, if lastInsertId is called before calling commit, the right id is returned.</span>
</div>
  

#


<div class="phpcode"><span class="html">
If you&apos;re accessing MSSQL/SQL Server 2008 R2 (or higher) from Linux via FreeTDS there&apos;s a slightly neater way of getting the last insert ID than the solution(s) outlined below.<br><br>The specific SQL involved is outlined here:<br><br><a href="http://msdn.microsoft.com/en-us/library/ms177564.aspx" rel="nofollow" target="_blank">http://msdn.microsoft.com/en-us/library/ms177564.aspx</a><br><br>So for example, with a table containing the two columns (product_id, product_name) where product_id is a uniqueidentifier or something similar you could do the following.<br><br><span class="default">&lt;?php<br><br></span><span class="comment">// Assume $dbh connection handle is already established<br><br></span><span class="default">$sql </span><span class="keyword">= </span><span class="string">&quot;INSERT INTO product (product_name) OUTPUT INSERTED.product_id VALUES (?)&quot;</span><span class="keyword">;<br><br></span><span class="default">$sth </span><span class="keyword">= </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br><br></span><span class="default">$sth</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">(array(</span><span class="string">&apos;widgets&apos;</span><span class="keyword">));<br><br></span><span class="default">$temp </span><span class="keyword">= </span><span class="default">$sth</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_ASSOC</span><span class="keyword">);<br><br></span><span class="default">?&gt;<br></span><br>Then $temp will contain an array like:<br><br>Array<br>(<br>&#xA0; &#xA0; [product_id] =&gt; E1DA1CB0-676A-4CD9-A22C-90C9D4E81914<br>)<br><br>Just be warned that there are some issues relating to how uniqueidentifier columns are handled by PDO_DBLIB/FreeTDS depending on the TDS version you choose that have only been fixed as of PHP 5.3.7.<br><br>Information regarding this and the patch can be found here:<br><br><a href="https://bugs.php.net/bug.php?id=54167" rel="nofollow" target="_blank">https://bugs.php.net/bug.php?id=54167</a></span>
</div>
  

#


<div class="phpcode"><span class="html">
I think I get a nice solution in Postgres to get the ID using the RETURNING that comes with Postgress since version 8.2. In the example below, I add to my insert clause the &quot;returning&quot; along with the primary key of my table, then after the execute, I do a fetch getting an array with the value of the last inserted id. 
<br>
<br><span class="default">&lt;?php
<br>&#xA0; &#xA0; </span><span class="keyword">public function </span><span class="default">insert</span><span class="keyword">(</span><span class="default">$employee</span><span class="keyword">){
<br>
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$sqlQuery </span><span class="keyword">= </span><span class="string">&quot;INSERT INTO employee(user_id,name,address,city) VALUES(:user_id,:name,:address,:city) RETURNING employee_id&quot;</span><span class="keyword">;
<br>
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$statement </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$sqlQuery</span><span class="keyword">);
<br>
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$a </span><span class="keyword">=</span><span class="string">&quot;2002-03-11 12:01AM&quot; </span><span class="keyword">;
<br>
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">&quot;:user_id&quot;</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getUserId</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_INT</span><span class="keyword">);
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">&quot;:name&quot;</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getName</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">&quot;:address&quot;</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getAddress</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bindParam</span><span class="keyword">(</span><span class="string">&quot;:city&quot;</span><span class="keyword">, </span><span class="default">$employee</span><span class="keyword">-&gt;</span><span class="default">getCity</span><span class="keyword">(), </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();
<br>&#xA0; &#xA0; &#xA0; &#xA0; 
<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_ASSOC</span><span class="keyword">);
<br>&#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">$result</span><span class="keyword">[</span><span class="string">&quot;employee_id&quot;</span><span class="keyword">];
<br>
<br>&#xA0; &#xA0; }
<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
It should be mentioned that this function DOES NOT retrieve the ID (Primary key) of the row but it&apos;s OID instead.<br><br>So if you use one of the latest PostgreSQL versions this function won&apos;t help you unless you add OID to the table specifically when you create it.</span>
</div>
  

#


<div class="phpcode"><span class="html">
in case anyone was wondering<br>something like<br><br>$val = 5;<br>$sql = &quot;REPLACE table (column) VALUES (:val)&quot;;<br>$stmt = $dbh-&gt;prepare($sql);<br>$stmt-&gt;bindParam(&apos;:val&apos;, $val, PDO::PARAM_INT);<br>$stmt-&gt;execute();<br>$lastId = $dbh-&gt;lastInsertId();<br><br>will return the last inserted id, whether the record was replaced or simply inserted<br><br>the REPLACE syntax, simply inserts, or deletes &gt; inserts<br>so lastInsertId() still works<br><br>refer to <a href="http://mysql.com/doc/refman/5.0/en/replace.html" rel="nofollow" target="_blank">http://mysql.com/doc/refman/5.0/en/replace.html</a><br>for REPLACE usage</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/pdo.lastinsertid.php)

**[To root](/README.md)**