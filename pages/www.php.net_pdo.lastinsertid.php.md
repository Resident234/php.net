# PDO::lastInsertId





Remember, if you use a transaction you should use lastInsertId BEFORE you commit
otherwise it will return 0

  

#



To save time for some of you.

When using MySQL or MariaDB while inserting multiple rows in a single query (INSERT INTO table (a,b,c) VALUES (1,2,3), (2,3,4), ...) to a table with auto_increment column, PDO::lastInsertId does NOT return the autogenerated id of the last row. Instead, the FIRST generated id is returned. This may very well be explained by taking a look at MySQL and MariaDB&apos;s documentation.

Quotations from their respective documentations, 

MySQL:
&quot;With no argument, LAST_INSERT_ID() returns a BIGINT UNSIGNED (64-bit) value representing the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement.&quot;

MariaDB:
&quot;LAST_INSERT_ID() (no arguments) returns the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement.&quot;

This is clearly not what lastInsertId&apos;s own documentation states. Hopefully this will save someone from debugging the cause of id mismatch.

tl;dr (MySQL | Mariadb) + multi row insert + PDO::lastInsertId = first autogenerated id

Behaviour tested using MariaDB 10.2.6 32-bit, PHP 5.6.31 32-bit and mysqlnd 5.0.11 running on windows 7.

  

#



Sorry to contradict Jonathon Hibbard&apos;s comment (http://php.net/manual/en/pdo.lastinsertid.php#82838), but my experiencie with INSERT INTO ... ON DUPLICATE KEY UPDATE is totally different; maybe it&apos;s due to PHP version (I&apos;m on Windows, 5.4.7; I realize his post is 6 years old) or to the database engine (MySQL in my case).

Nevertheless, if I do an INSERT INTO ... ON DUPLICATE KEY UPDATE (something like id=id or equivalent, where the updated value is equal to the original one), this is what I&apos;m getting:

- If the key didn&apos;t exist, the value is inserted, and lastInsertId() returns the expected id for the new row.

- If the row exists AND a value is updated, with lastInsertId() I get the ID of the updated row.

- If the row exists but NO value is updated, lastInsertId() returns 0.

That contradicts his example, where he assures that
&quot;INSERT INTO city (`city`) VALUES (&apos;Paris&apos;) ON DUPLICATE KEY UPDATE `city` = &apos;Paris&apos;&quot;
returns 2 (??) on lastInsertId() and that he expected to return 1 &quot;since no records were inserted&quot; (??).

Hope this helps someone.

  

#



Beware of lastInsertId() when working with transactions in mysql. The following code returns 0 instead of the insert id.





```
<?php

try {

&#xA0; &#xA0; $dbh = new PDO(&apos;mysql:host=localhost;dbname=test&apos;, &apos;username&apos;, &apos;password&apos;);



&#xA0; &#xA0; $stmt = $dbh-&gt;prepare(&quot;INSERT INTO test (name, email) VALUES(?,?)&quot;);



&#xA0; &#xA0; try {

&#xA0; &#xA0; &#xA0; &#xA0; $dbh-&gt;beginTransaction();

&#xA0; &#xA0; &#xA0; &#xA0; $tmt-&gt;execute( array(&apos;user&apos;, &apos;user@example.com&apos;));

&#xA0; &#xA0; &#xA0; &#xA0; $dbh-&gt;commit();

&#xA0; &#xA0; &#xA0; &#xA0; print $dbh-&gt;lastInsertId();

&#xA0; &#xA0; } catch(PDOExecption $e) {

&#xA0; &#xA0; &#xA0; &#xA0; $dbh-&gt;rollback();

&#xA0; &#xA0; &#xA0; &#xA0; print &quot;Error!: &quot; . $e-&gt;getMessage() . &quot;&lt;/br&gt;&quot;;

&#xA0; &#xA0; }

} catch( PDOExecption $e ) {

&#xA0; &#xA0; print &quot;Error!: &quot; . $e-&gt;getMessage() . &quot;&lt;/br&gt;&quot;;

}

?>
```




When no exception is thrown, lastInsertId returns 0. However, if lastInsertId is called before calling commit, the right id is returned.

  

#



If you&apos;re accessing MSSQL/SQL Server 2008 R2 (or higher) from Linux via FreeTDS there&apos;s a slightly neater way of getting the last insert ID than the solution(s) outlined below.

The specific SQL involved is outlined here:

http://msdn.microsoft.com/en-us/library/ms177564.aspx

So for example, with a table containing the two columns (product_id, product_name) where product_id is a uniqueidentifier or something similar you could do the following.



```
<?php

// Assume $dbh connection handle is already established

$sql = &quot;INSERT INTO product (product_name) OUTPUT INSERTED.product_id VALUES (?)&quot;;

$sth = $dbh-&gt;prepare($sql);

$sth-&gt;execute(array(&apos;widgets&apos;));

$temp = $sth-&gt;fetch(PDO::FETCH_ASSOC);

?>
```


Then $temp will contain an array like:

Array
(
&#xA0; &#xA0; [product_id] =&gt; E1DA1CB0-676A-4CD9-A22C-90C9D4E81914
)

Just be warned that there are some issues relating to how uniqueidentifier columns are handled by PDO_DBLIB/FreeTDS depending on the TDS version you choose that have only been fixed as of PHP 5.3.7.

Information regarding this and the patch can be found here:

https://bugs.php.net/bug.php?id=54167

  

#



I think I get a nice solution in Postgres to get the ID using the RETURNING that comes with Postgress since version 8.2. In the example below, I add to my insert clause the &quot;returning&quot; along with the primary key of my table, then after the execute, I do a fetch getting an array with the value of the last inserted id. 





```
<?php

&#xA0; &#xA0; public function insert($employee){



&#xA0; &#xA0; &#xA0; &#xA0; $sqlQuery = &quot;INSERT INTO employee(user_id,name,address,city) VALUES(:user_id,:name,:address,:city) RETURNING employee_id&quot;;



&#xA0; &#xA0; &#xA0; &#xA0; $statement = $this-&gt;prepare($sqlQuery);



&#xA0; &#xA0; &#xA0; &#xA0; $a =&quot;2002-03-11 12:01AM&quot; ;



&#xA0; &#xA0; &#xA0; &#xA0; $statement-&gt;bindParam(&quot;:user_id&quot;, $employee-&gt;getUserId(), PDO::PARAM_INT);

&#xA0; &#xA0; &#xA0; &#xA0; $statement-&gt;bindParam(&quot;:name&quot;, $employee-&gt;getName(), PDO::PARAM_STR);

&#xA0; &#xA0; &#xA0; &#xA0; $statement-&gt;bindParam(&quot;:address&quot;, $employee-&gt;getAddress(), PDO::PARAM_STR);

&#xA0; &#xA0; &#xA0; &#xA0; $statement-&gt;bindParam(&quot;:city&quot;, $employee-&gt;getCity(), PDO::PARAM_STR);

&#xA0; &#xA0; &#xA0; &#xA0; $statement-&gt;execute();

&#xA0; &#xA0; &#xA0; &#xA0; 

&#xA0; &#xA0; &#xA0; &#xA0; $result = $statement-&gt;fetch(PDO::FETCH_ASSOC);

&#xA0; &#xA0; &#xA0; &#xA0; return $result[&quot;employee_id&quot;];



&#xA0; &#xA0; }

?>
```



  

#



It should be mentioned that this function DOES NOT retrieve the ID (Primary key) of the row but it&apos;s OID instead.

So if you use one of the latest PostgreSQL versions this function won&apos;t help you unless you add OID to the table specifically when you create it.

  

#



in case anyone was wondering
something like

$val = 5;
$sql = &quot;REPLACE table (column) VALUES (:val)&quot;;
$stmt = $dbh-&gt;prepare($sql);
$stmt-&gt;bindParam(&apos;:val&apos;, $val, PDO::PARAM_INT);
$stmt-&gt;execute();
$lastId = $dbh-&gt;lastInsertId();

will return the last inserted id, whether the record was replaced or simply inserted

the REPLACE syntax, simply inserts, or deletes &gt; inserts
so lastInsertId() still works

refer to http://mysql.com/doc/refman/5.0/en/replace.html
for REPLACE usage

  

#

[Official documentation page](https://www.php.net/manual/en/pdo.lastinsertid.php)

**[To root](/README.md)**