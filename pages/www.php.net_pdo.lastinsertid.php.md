# PDO::lastInsertId



Remember, if you use a transaction you should use lastInsertId BEFORE you commit<br>otherwise it will return 0  

#

To save time for some of you.<br><br>When using MySQL or MariaDB while inserting multiple rows in a single query (INSERT INTO table (a,b,c) VALUES (1,2,3), (2,3,4), ...) to a table with auto_increment column, PDO::lastInsertId does NOT return the autogenerated id of the last row. Instead, the FIRST generated id is returned. This may very well be explained by taking a look at MySQL and MariaDB&apos;s documentation.<br><br>Quotations from their respective documentations, <br><br>MySQL:<br>"With no argument, LAST_INSERT_ID() returns a BIGINT UNSIGNED (64-bit) value representing the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement."<br><br>MariaDB:<br>"LAST_INSERT_ID() (no arguments) returns the first automatically generated value successfully inserted for an AUTO_INCREMENT column as a result of the most recently executed INSERT statement."<br><br>This is clearly not what lastInsertId&apos;s own documentation states. Hopefully this will save someone from debugging the cause of id mismatch.<br><br>tl;dr (MySQL | Mariadb) + multi row insert + PDO::lastInsertId = first autogenerated id<br><br>Behaviour tested using MariaDB 10.2.6 32-bit, PHP 5.6.31 32-bit and mysqlnd 5.0.11 running on windows 7.  

#

Sorry to contradict Jonathon Hibbard&apos;s comment (http://php.net/manual/en/pdo.lastinsertid.php#82838), but my experiencie with INSERT INTO ... ON DUPLICATE KEY UPDATE is totally different; maybe it&apos;s due to PHP version (I&apos;m on Windows, 5.4.7; I realize his post is 6 years old) or to the database engine (MySQL in my case).<br><br>Nevertheless, if I do an INSERT INTO ... ON DUPLICATE KEY UPDATE (something like id=id or equivalent, where the updated value is equal to the original one), this is what I&apos;m getting:<br><br>- If the key didn&apos;t exist, the value is inserted, and lastInsertId() returns the expected id for the new row.<br><br>- If the row exists AND a value is updated, with lastInsertId() I get the ID of the updated row.<br><br>- If the row exists but NO value is updated, lastInsertId() returns 0.<br><br>That contradicts his example, where he assures that<br>"INSERT INTO city (`city`) VALUES (&apos;Paris&apos;) ON DUPLICATE KEY UPDATE `city` = &apos;Paris&apos;"<br>returns 2 (??) on lastInsertId() and that he expected to return 1 "since no records were inserted" (??).<br><br>Hope this helps someone.  

#

Beware of lastInsertId() when working with transactions in mysql. The following code returns 0 instead of the insert id.<br><br>

```
<?php
try {
    $dbh = new PDO('mysql:host=localhost;dbname=test', 'username', 'password');

    $stmt = $dbh->prepare("INSERT INTO test (name, email) VALUES(?,?)");

    try {
        $dbh->beginTransaction();
        $tmt->execute( array('user', 'user@example.com'));
        $dbh->commit();
        print $dbh->lastInsertId();
    } catch(PDOExecption $e) {
        $dbh->rollback();
        print "Error!: " . $e->getMessage() . "</br>";
    }
} catch( PDOExecption $e ) {
    print "Error!: " . $e->getMessage() . "</br>";
}
?>
```
<br><br>When no exception is thrown, lastInsertId returns 0. However, if lastInsertId is called before calling commit, the right id is returned.  

#

If you&apos;re accessing MSSQL/SQL Server 2008 R2 (or higher) from Linux via FreeTDS there&apos;s a slightly neater way of getting the last insert ID than the solution(s) outlined below.<br><br>The specific SQL involved is outlined here:<br><br>http://msdn.microsoft.com/en-us/library/ms177564.aspx<br><br>So for example, with a table containing the two columns (product_id, product_name) where product_id is a uniqueidentifier or something similar you could do the following.<br><br>

```
<?php

// Assume $dbh connection handle is already established

$sql = "INSERT INTO product (product_name) OUTPUT INSERTED.product_id VALUES (?)";

$sth = $dbh->prepare($sql);

$sth->execute(array('widgets'));

$temp = $sth->fetch(PDO::FETCH_ASSOC);

?>
```
<br><br>Then $temp will contain an array like:<br><br>Array<br>(<br>    [product_id] =&gt; E1DA1CB0-676A-4CD9-A22C-90C9D4E81914<br>)<br><br>Just be warned that there are some issues relating to how uniqueidentifier columns are handled by PDO_DBLIB/FreeTDS depending on the TDS version you choose that have only been fixed as of PHP 5.3.7.<br><br>Information regarding this and the patch can be found here:<br><br>https://bugs.php.net/bug.php?id=54167  

#

I think I get a nice solution in Postgres to get the ID using the RETURNING that comes with Postgress since version 8.2. In the example below, I add to my insert clause the "returning" along with the primary key of my table, then after the execute, I do a fetch getting an array with the value of the last inserted id. <br><br>

```
<?php
    public function insert($employee){

        $sqlQuery = "INSERT INTO employee(user_id,name,address,city) VALUES(:user_id,:name,:address,:city) RETURNING employee_id";

        $statement = $this->prepare($sqlQuery);

        $a ="2002-03-11 12:01AM" ;

        $statement->bindParam(":user_id", $employee->getUserId(), PDO::PARAM_INT);
        $statement->bindParam(":name", $employee->getName(), PDO::PARAM_STR);
        $statement->bindParam(":address", $employee->getAddress(), PDO::PARAM_STR);
        $statement->bindParam(":city", $employee->getCity(), PDO::PARAM_STR);
        $statement->execute();
        
        $result = $statement->fetch(PDO::FETCH_ASSOC);
        return $result["employee_id"];

    }
?>
```
  

#

It should be mentioned that this function DOES NOT retrieve the ID (Primary key) of the row but it&apos;s OID instead.<br><br>So if you use one of the latest PostgreSQL versions this function won&apos;t help you unless you add OID to the table specifically when you create it.  

#

in case anyone was wondering<br>something like<br><br>$val = 5;<br>$sql = "REPLACE table (column) VALUES (:val)";<br>$stmt = $dbh-&gt;prepare($sql);<br>$stmt-&gt;bindParam(&apos;:val&apos;, $val, PDO::PARAM_INT);<br>$stmt-&gt;execute();<br>$lastId = $dbh-&gt;lastInsertId();<br><br>will return the last inserted id, whether the record was replaced or simply inserted<br><br>the REPLACE syntax, simply inserts, or deletes &gt; inserts<br>so lastInsertId() still works<br><br>refer to http://mysql.com/doc/refman/5.0/en/replace.html<br>for REPLACE usage  

#

[Official documentation page](https://www.php.net/manual/en/pdo.lastinsertid.php)

**[To root](/README.md)**