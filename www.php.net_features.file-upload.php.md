# Handling file uploads




<div class="phpcode"><span class="html">
You&apos;d better check $_FILES structure and values throughly.<br>The following code cannot cause any errors absolutely.<br><br>Example:<br><span class="default">&lt;?php<br><br>header</span><span class="keyword">(</span><span class="string">&apos;Content-Type: text/plain; charset=utf-8&apos;</span><span class="keyword">);<br><br>try {<br>&#xA0; &#xA0; <br>&#xA0; &#xA0; </span><span class="comment">// Undefined | Multiple Files | $_FILES Corruption Attack<br>&#xA0; &#xA0; // If this request falls under any of them, treat it invalid.<br>&#xA0; &#xA0; </span><span class="keyword">if (<br>&#xA0; &#xA0; &#xA0; &#xA0; !isset(</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;error&apos;</span><span class="keyword">]) ||<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">is_array</span><span class="keyword">(</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;error&apos;</span><span class="keyword">])<br>&#xA0; &#xA0; ) {<br>&#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;Invalid parameters.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="comment">// Check $_FILES[&apos;upfile&apos;][&apos;error&apos;] value.<br>&#xA0; &#xA0; </span><span class="keyword">switch (</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;error&apos;</span><span class="keyword">]) {<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">UPLOAD_ERR_OK</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; break;<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">UPLOAD_ERR_NO_FILE</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;No file sent.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">UPLOAD_ERR_INI_SIZE</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; case </span><span class="default">UPLOAD_ERR_FORM_SIZE</span><span class="keyword">:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;Exceeded filesize limit.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; default:<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;Unknown errors.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="comment">// You should also check filesize here. <br>&#xA0; &#xA0; </span><span class="keyword">if (</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;size&apos;</span><span class="keyword">] &gt; </span><span class="default">1000000</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;Exceeded filesize limit.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="comment">// DO NOT TRUST $_FILES[&apos;upfile&apos;][&apos;mime&apos;] VALUE !!<br>&#xA0; &#xA0; // Check MIME Type by yourself.<br>&#xA0; &#xA0; </span><span class="default">$finfo </span><span class="keyword">= new </span><span class="default">finfo</span><span class="keyword">(</span><span class="default">FILEINFO_MIME_TYPE</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$ext </span><span class="keyword">= </span><span class="default">array_search</span><span class="keyword">(<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$finfo</span><span class="keyword">-&gt;</span><span class="default">file</span><span class="keyword">(</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;tmp_name&apos;</span><span class="keyword">]),<br>&#xA0; &#xA0; &#xA0; &#xA0; array(<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;jpg&apos; </span><span class="keyword">=&gt; </span><span class="string">&apos;image/jpeg&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;png&apos; </span><span class="keyword">=&gt; </span><span class="string">&apos;image/png&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&apos;gif&apos; </span><span class="keyword">=&gt; </span><span class="string">&apos;image/gif&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; ),<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">true<br>&#xA0; &#xA0; </span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;Invalid file format.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; </span><span class="comment">// You should name it uniquely.<br>&#xA0; &#xA0; // DO NOT USE $_FILES[&apos;upfile&apos;][&apos;name&apos;] WITHOUT ANY VALIDATION !!<br>&#xA0; &#xA0; // On this example, obtain safe unique name from its binary data.<br>&#xA0; &#xA0; </span><span class="keyword">if (!</span><span class="default">move_uploaded_file</span><span class="keyword">(<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;tmp_name&apos;</span><span class="keyword">],<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">&apos;./uploads/%s.%s&apos;</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">sha1_file</span><span class="keyword">(</span><span class="default">$_FILES</span><span class="keyword">[</span><span class="string">&apos;upfile&apos;</span><span class="keyword">][</span><span class="string">&apos;tmp_name&apos;</span><span class="keyword">]),<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$ext<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="keyword">)<br>&#xA0; &#xA0; )) {<br>&#xA0; &#xA0; &#xA0; &#xA0; throw new </span><span class="default">RuntimeException</span><span class="keyword">(</span><span class="string">&apos;Failed to move uploaded file.&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; echo </span><span class="string">&apos;File is uploaded successfully.&apos;</span><span class="keyword">;<br><br>} catch (</span><span class="default">RuntimeException $e</span><span class="keyword">) {<br><br>&#xA0; &#xA0; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">();<br><br>}<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
If &quot;large files&quot; (ie: 50 or 100 MB) fail, check this:<br><br>It may happen that your outgoing connection to the server is slow, and it may timeout not the &quot;execution time&quot; but the &quot;input time&quot;, which for example in our system defaulted to 60s. In our case a large upload could take 1 or 2 hours.<br><br>Additionally we had &quot;session settings&quot; that should be preserved after upload.<br><br>1) You might want review those ini entries:<br><br>* session.gc_maxlifetime<br>* max_input_time<br>* max_execution_time<br>* upload_max_filesize<br>* post_max_size<br><br>2) Still fails? Caution, not all are changeable from the script itself. ini_set() might fail to override.<br><br>More info here:<br><a href="http://www.php.net/manual/es/ini.list.php" rel="nofollow" target="_blank">http://www.php.net/manual/es/ini.list.php</a><br><br>You can see that the &quot;upload_max_filesize&quot;, among others, is PHP_INI_PERDIR and not PHP_INI_ALL. This invalidates to use ini_set():<br><a href="http://www.php.net/manual/en/configuration.changes.modes.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/configuration.changes.modes.php</a><br><br>Use .htaccess instead.<br><br>3) Still fails?. Just make sure you enabled &quot;.htaccess&quot; to overwrite your php settings. This is made in the apache file. You need at least AllowOverride Options.<br><br>See this here:<br><a href="http://www.php.net/manual/en/configuration.changes.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/configuration.changes.php</a><br><br>You will necessarily allow this manually in the case your master files come with AllowOverride None.<br><br>Conclussion:<br><br>Depending on the system, to allow &quot;large file uploads&quot; you must go up and up and up and touch your config necessarily up to the apache config.<br><br>Sample files:<br><br>These work for me, for 100MB uploads, lasting 2 hours:<br><br>In apache-virtual-host:<br>-----------------------------------------------------------<br>&lt;Directory /var/www/MyProgram&gt;<br>&#xA0; &#xA0; AllowOverride Options<br>&lt;/Directory&gt;<br>-----------------------------------------------------------<br><br>In .htaccess:<br>-----------------------------------------------------------<br>php_value session.gc_maxlifetime 10800<br>php_value max_input_time&#xA0; &#xA0; &#xA0; &#xA0;&#xA0; 10800<br>php_value max_execution_time&#xA0; &#xA0;&#xA0; 10800<br>php_value upload_max_filesize&#xA0; &#xA0; 110M<br>php_value post_max_size&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; 120M<br>-----------------------------------------------------------<br><br>In the example,<br>- As I last 1 to 2 hours, I allow 3 hours (3600x3)<br>- As I need 100MB, I allow air above for the file (110M) and a bit more for the whole post (120M).</span>
</div>
  

#


<div class="phpcode"><span class="html">
Caution: *DO NOT* trust $_FILES[&apos;userfile&apos;][&apos;type&apos;] to verify the uploaded filetype; if you do so your server could be compromised.&#xA0; I&apos;ll show you why below:<br><br>The manual (if you scroll above) states: $_FILES[&apos;userfile&apos;][&apos;type&apos;] -&#xA0; The mime type of the file, if the browser provided this information. An example would be &quot;image/gif&quot;.<br><br>Be reminded that this mime type can easily be faked as PHP doesn&apos;t go very far in verifying whether it really is what the end user reported!<br><br>So, someone could upload a nasty .php script as an &quot;image/gif&quot; and execute the url to the &quot;image&quot;.<br><br>My best bet would be for you to check the extension of the file and using exif_imagetype() to check for valid images.&#xA0; Many people have suggested the use of getimagesize() which returns an array if the file is indeed an image and false otherwise, but exif_imagetype() is much faster. (the manual says it so)</span>
</div>
  

#


<div class="phpcode"><span class="html">
Using /var/www/uploads in the example code is just criminal, imnsho.<br><br>One should *NOT* upload untrusted files into your web tree, on any server.<br><br>Nor should any directory within your web tree have permissions sufficient for an upload to succeed, on a shared server. Any other user on that shared server could write a PHP script to dump anything they want in there!<br><br>The $_FILES[&apos;userfile&apos;][&apos;type&apos;] is essentially USELESS.<br>A. Browsers aren&apos;t consistent in their mime-types, so you&apos;ll never catch all the possible combinations of types for any given file format.<br>B. It can be forged, so it&apos;s crappy security anyway.<br><br>One&apos;s code should INSPECT the actual file to see if it looks kosher.<br><br>For example, images can quickly and easily be run through imagegetsize and you at least know the first N bytes LOOK like an image.&#xA0; That doesn&apos;t guarantee it&apos;s a valid image, but it makes it much less likely to be a workable security breaching file.<br><br>For Un*x based servers, one could use exec and &apos;file&apos; command to see if the Operating System thinks the internal contents seem consistent with the data type you expect.<br><br>I&apos;ve had trouble in the past with reading the &apos;/tmp&apos; file in a file upload.&#xA0; It would be nice if PHP let me read that file BEFORE I tried to move_uploaded_file on it, but PHP won&apos;t, presumably under the assumption that I&apos;d be doing something dangerous to read an untrusted file.&#xA0; Fine.&#xA0;&#xA0; One should move the uploaded file to some staging directory.&#xA0; Then you check out its contents as thoroughly as you can.&#xA0; THEN, if it seems kosher, move it into a directory outside your web tree.&#xA0; Any access to that file should be through a PHP script which reads the file.&#xA0; Putting it into your web tree, even with all the checks you can think of, is just too dangerous, imnsho.<br><br>There are more than a few User Contributed notes here with naive (bad) advice.&#xA0; Be wary.</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/features.file-upload.php)

**[To root](/README.md)**