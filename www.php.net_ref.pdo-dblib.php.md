# Microsoft SQL Server and Sybase Functions (PDO_DBLIB)




<div class="phpcode"><span class="html">
Hi All, I&apos;wrote a class to connect to MSSQL/Azure databases with Transaction support.<br><br>Hope this can help anyone!<br><br><span class="default">&lt;?php<br></span><span class="comment">/**<br>*&#xA0; &#xA0; @author&#xA0; &#xA0;&#xA0; Johan Kasselman &lt;johankasselman@live.com&gt;<br>*&#xA0; &#xA0; @since&#xA0; &#xA0; &#xA0; &#xA0;&#xA0; 2015-09-28&#xA0; &#xA0; V1<br>*<br>*/<br><br></span><span class="keyword">class </span><span class="default">pdo_dblib_mssql</span><span class="keyword">{<br><br>&#xA0; &#xA0; private </span><span class="default">$db</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0;&#xA0; private </span><span class="default">$cTransID</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0;&#xA0; private </span><span class="default">$childTrans </span><span class="keyword">= array();<br><br>&#xA0; &#xA0; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">, </span><span class="default">$dbname</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$pwd</span><span class="keyword">){<br><br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">hostname </span><span class="keyword">= </span><span class="default">$hostname</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">port </span><span class="keyword">= </span><span class="default">$port</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbname </span><span class="keyword">= </span><span class="default">$dbname</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">username </span><span class="keyword">= </span><span class="default">$username</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">pwd </span><span class="keyword">= </span><span class="default">$pwd</span><span class="keyword">;<br><br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connect</span><span class="keyword">();<br>&#xA0; &#xA0; &#xA0; &#xA0; <br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; public function </span><span class="default">beginTransaction</span><span class="keyword">(){<br><br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$cAlphanum </span><span class="keyword">= </span><span class="string">&quot;AaBbCc0Dd1EeF2fG3gH4hI5iJ6jK7kLlM8mN9nOoPpQqRrSsTtUuVvWwXxYyZz&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cTransID </span><span class="keyword">= </span><span class="string">&quot;T&quot;</span><span class="keyword">.</span><span class="default">substr</span><span class="keyword">(</span><span class="default">str_shuffle</span><span class="keyword">(</span><span class="default">$cAlphanum</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">7</span><span class="keyword">);<br><br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">array_unshift</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childTrans</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cTransID</span><span class="keyword">);<br><br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&quot;BEGIN TRAN [</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cTransID</span><span class="string">];&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br><br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; public function </span><span class="default">rollBack</span><span class="keyword">(){<br>&#xA0; &#xA0; &#xA0; &#xA0; <br>&#xA0; &#xA0; &#xA0; &#xA0; while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childTrans</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">){<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$cTmp </span><span class="keyword">= </span><span class="default">array_shift</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childTrans</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&quot;ROLLBACK TRAN [</span><span class="default">$cTmp</span><span class="string">];&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br><br>&#xA0; &#xA0; &#xA0; &#xA0; return </span><span class="default">$stmt</span><span class="keyword">;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; public function </span><span class="default">commit</span><span class="keyword">(){<br><br>&#xA0; &#xA0; &#xA0; &#xA0; while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childTrans</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">){<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$cTmp </span><span class="keyword">= </span><span class="default">array_shift</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childTrans</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&quot;COMMIT TRAN [</span><span class="default">$cTmp</span><span class="string">];&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br><br>&#xA0; &#xA0; &#xA0; &#xA0; return&#xA0; </span><span class="default">$stmt</span><span class="keyword">;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; public function </span><span class="default">close</span><span class="keyword">(){<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">db </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br>&#xA0; &#xA0; }<br><br>&#xA0; &#xA0; public function </span><span class="default">connect</span><span class="keyword">(){<br><br>&#xA0; &#xA0; &#xA0; &#xA0; try {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">db </span><span class="keyword">= new </span><span class="default">PDO </span><span class="keyword">(</span><span class="string">&quot;dblib:host=</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">hostname</span><span class="string">:</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">port</span><span class="string">;dbname=</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbname</span><span class="string">&quot;</span><span class="keyword">, </span><span class="string">&quot;</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">username</span><span class="string">&quot;</span><span class="keyword">, </span><span class="string">&quot;</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">pwd</span><span class="string">&quot;</span><span class="keyword">);<br><br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; <br><br>&#xA0; &#xA0; &#xA0; &#xA0; } catch (</span><span class="default">PDOException $e</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">logsys </span><span class="keyword">.= </span><span class="string">&quot;Failed to get DB handle: &quot; </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">&quot;\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br><br>&#xA0; &#xA0; }<br><br>}<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
There is currently little sybase related PDO docs out there. The ones that I found often mention a spec for a dsn that is invalid. Here&apos;s how I am currently connecting to sybase ASE:<br><br>1. Compile up freetds <a href="http://www.freetds.org" rel="nofollow" target="_blank">http://www.freetds.org</a> on top of open client;<br>2. Add the PDO and PD_DBLIB modules to php 5 as per the documentation; Note: I&apos;m currently using the PDO-beta and PDO_DBLIB-beta;<br>3. Check mods installed ok using &quot;pear list&quot; and &quot;php -m&quot;;<br><br>The documentation often says to use &quot;sybase:&quot; as your DSN, this doesn&apos;t work. Use &quot;dblib:&quot; instead. Here&apos;s an example:<br><br><span class="default">&lt;?php<br>&#xA0; </span><span class="keyword">try {<br>&#xA0; &#xA0; </span><span class="default">$hostname </span><span class="keyword">= </span><span class="string">&quot;myhost&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$port </span><span class="keyword">= </span><span class="default">10060</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$dbname </span><span class="keyword">= </span><span class="string">&quot;tempdb&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$username </span><span class="keyword">= </span><span class="string">&quot;dbuser&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$pw </span><span class="keyword">= </span><span class="string">&quot;password&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$dbh </span><span class="keyword">= new </span><span class="default">PDO </span><span class="keyword">(</span><span class="string">&quot;dblib:host=</span><span class="default">$hostname</span><span class="string">:</span><span class="default">$port</span><span class="string">;dbname=</span><span class="default">$dbname</span><span class="string">&quot;</span><span class="keyword">,</span><span class="string">&quot;</span><span class="default">$username</span><span class="string">&quot;</span><span class="keyword">,</span><span class="string">&quot;</span><span class="default">$pw</span><span class="string">&quot;</span><span class="keyword">);<br>&#xA0; } catch (</span><span class="default">PDOException $e</span><span class="keyword">) {<br>&#xA0; &#xA0; echo </span><span class="string">&quot;Failed to get DB handle: &quot; </span><span class="keyword">. </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">&quot;\n&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; exit;<br>&#xA0; }<br>&#xA0; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$dbh</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">&quot;select name from master..sysdatabases where name = db_name()&quot;</span><span class="keyword">);<br>&#xA0; </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br>&#xA0; while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">()) {<br>&#xA0; &#xA0; </span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">);<br>&#xA0; }<br>&#xA0; unset(</span><span class="default">$dbh</span><span class="keyword">); unset(</span><span class="default">$stmt</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>Hope this helps.</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/ref.pdo-dblib.php)

**[To root](/README.md)**