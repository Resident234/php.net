# ldap_bind




<div class="phpcode"><span class="html">
Interesting point,<br><br>if you can&apos;t bind to active directory with the error &quot;49: Invalid Credentials&quot;, you can get the extended error output from the ldap_get_option function, using the option: LDAP_OPT_DIAGNOSTIC_MESSAGE. Unfortunately php hasn&apos;t defined this by default, but it&apos;s value is 0x0032.<br><br>This is useful if a user must change their password at first login (Data: 773), or if their account has expired on the network (Data: 532).<br><br><span class="default">&lt;?php<br><br>define</span><span class="keyword">(</span><span class="default">LDAP_OPT_DIAGNOSTIC_MESSAGE</span><span class="keyword">, </span><span class="default">0x0032</span><span class="keyword">)<br><br></span><span class="default">$handle </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="string">&apos;ldap://active.directory.server/&apos;</span><span class="keyword">);<br></span><span class="default">$bind </span><span class="keyword">= </span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="string">&apos;user&apos;</span><span class="keyword">, </span><span class="string">&apos;expiredpass&apos;</span><span class="keyword">);<br><br>if (</span><span class="default">$bind</span><span class="keyword">) {<br>&#xA0; &#xA0; if (</span><span class="default">ldap_get_option</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LDAP_OPT_DIAGNOSTIC_MESSAGE</span><span class="keyword">, </span><span class="default">$extended_error</span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&quot;Error Binding to LDAP: </span><span class="default">$extended_error</span><span class="string">&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; echo </span><span class="string">&quot;Error Binding to LDAP: No additional information is available.&quot;</span><span class="keyword">;<br>&#xA0; &#xA0; }<br>}<br></span><span class="default">?&gt;<br></span><br>Or something to that effect..<br><br>It took me a while to work this one out, so i figured i&apos;d share my results..</span>
</div>
  

#


<div class="phpcode"><span class="html">
I couldn&apos;t get ldap_bind to work on an ldaps connection until I followed some instructions about creating an ldap.conf file.&#xA0; I don&apos;t see these instructions anywhere on the php site.&#xA0; Maybe they&apos;re on the OpenLDAP site, but I thought it would be useful to have here as well.&#xA0; Credit goes to a dude known as &apos;LRM&apos;, and I found my solution here: <a href="http://lists.horde.org/archives/sork/Week-of-Mon-20040503/001578.html" rel="nofollow" target="_blank">http://lists.horde.org/archives/sork/Week-of-Mon-20040503/001578.html</a><br><br>My setup is XAMPP on Win XP.<br>###### ApacheFriends XAMPP (basic package) version 1.6.3a ######<br><br>&#xA0; + Apache 2.2.4<br>&#xA0; + MySQL 5.0.45<br>&#xA0; + PHP 5.2.3 + PHP 4.4.7 + PEAR<br>&#xA0; + PHP-Switch win32 1.0 (please use the &quot;php-switch.bat&quot;)<br>&#xA0; + XAMPP Control Version 2.5 from www.nat32.com&#xA0; &#xA0; <br>&#xA0; + XAMPP Security 1.0&#xA0; &#xA0; <br>&#xA0; + SQLite 2.8.15<br>&#xA0; + OpenSSL 0.9.8e<br>&#xA0; + phpMyAdmin 2.10.3<br>&#xA0; + ADOdb 4.95<br>&#xA0; + Mercury Mail Transport System v4.01b<br>&#xA0; + FileZilla FTP Server 0.9.23<br>&#xA0; + Webalizer 2.01-10<br>&#xA0; + Zend Optimizer 3.3.0<br>&#xA0; + eAccelerator 0.9.5.1 for PHP 5.2.3&#xA0; (comment out in the php.ini)<br><br>1. create C:\OpenLDAP\sysconf\ldap.conf (Yes, it MUST be this path because it&apos;s hard-coded in the dll)<br>2. put this line at the top:<br><br>TLS_REQCERT never<br><br>3. Save, stop/start apache.<br><br>The reason is, I think, because it doesn&apos;t understand the certificate, so this directive tells it to not bother checking it.&#xA0; I guess that could be unsafe in some cases, but in my case I&apos;m confident with the server I&apos;m connecting to.<br><br>My connection code was as follows (nothing new here, I don&apos;t think):<br><br><span class="default">&lt;?php<br>$con </span><span class="keyword">= @</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="string">&apos;ldaps://the.ldap.server&apos;</span><span class="keyword">, </span><span class="default">636</span><span class="keyword">);<br></span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$con</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br></span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$con</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br></span><span class="default">var_dump</span><span class="keyword">(@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$con</span><span class="keyword">, </span><span class="string">&apos;user@sub.domain.com&apos;</span><span class="keyword">, </span><span class="string">&apos;password&apos;</span><span class="keyword">));<br></span><span class="default">?&gt;<br></span><br>Good luck!&#xA0; LDAPS can be a real bitch.</span>
</div>
  

#


<div class="phpcode"><span class="html">
A number of examples and implementations of authentication schemes which use LDAP simple binds to authenticate users fail to properly sanitize user-submitted data. This can allow for an anonymous user to authenticate to a web-based application as an existing user. Provided below is a brief description and example of how this vulnerability can arise. For more detailed information please visit the links at the bottom of this posting.<br><br>The bind operation of LDAP, as described in RFC 4513, provides a method which allows for authentication of users. For the Simple Authentication Method a user may use the anonymous authentication mechanism, the unauthenticated authentication mechanism, or the name/password authentication mechanism. The unauthenticated authentication mechanism is used when a client who desires to establish an anonymous authorization state passes a non-zero length distinguished name and a zero length password. Most LDAP servers either can be configured to allow this mechanism or allow it by default. Web-based applications which perform the simple bind operation with the client&apos;s credentials are at risk when an anonymous authorization state is established. This can occur when the web-based application passes a distinguished name and a zero length password to the LDAP server.<br>This is commonly encountered when no password is provided from the client to the web-based application. This situation is described in some of the postings found below. For this situation, the recommendations found in other postings is sufficient to prevent authentication bypass.<br>However, no prior postings at php.net describe a situation in which a client may pass a distinguished username and a password of non-zero length to the web-based application which results in an anonymous authorization state. Below is an example of this situation.<br><br>$dn=&quot;testuser&quot;;<br>$pass=&quot;\x00\x41&quot;;<br>if (empty($dn) or empty($pass)) { exit(); } //check for empty strings<br>//if (preg_match(&apos;/[^a-zA-Z]/&apos;,$dn) or preg_match(&apos;/[^a-zA-Z0-9\x20!@#$%^&amp;*()]/&apos;,$pass)) { exit(); } //check for expected values (whitelisting)<br>//if (preg_match(&apos;/\x00/&apos;,$dn) or preg_match(&apos;/\x00/&apos;,$pass)) { exit(); } //check for null byte (blacklisting)<br>$ldapconn=ldap_connect(&quot;192.0.2.2&quot;) or die(&quot;Could not connect to LDAP server.&quot;);<br>if ($ldapconn) {<br>&#xA0; &#xA0; &#xA0; &#xA0; ldap_set_option($ldapconn, LDAP_OPT_PROTOCOL_VERSION, 3);<br>&#xA0; &#xA0; &#xA0; &#xA0; $ldapbind=ldap_bind($ldapconn, $dn, $pass);<br>&#xA0; &#xA0; &#xA0; &#xA0; if ($ldapbind) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; echo(&quot;success&quot;);<br>&#xA0; &#xA0; &#xA0; &#xA0; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; echo(&quot;fail&quot;);<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br><br>References:<br><a href="http://security.okstate.edu" rel="nofollow" target="_blank">http://security.okstate.edu</a></span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/function.ldap-bind.php)

**[â¬† to root](/)**