# LDAP Functions




<div class="phpcode"><span class="html">
First of all, sorry for my English.<br>Here are two functions to check group membership and some others which can be useful for work with LDAP (Active Directory in this example).<br><br>index.php<br>---------<br><br><span class="default">&lt;?php<br><br>$user </span><span class="keyword">= </span><span class="string">&apos;bob&apos;</span><span class="keyword">;<br></span><span class="default">$password </span><span class="keyword">= </span><span class="string">&apos;zhlob&apos;</span><span class="keyword">;<br></span><span class="default">$host </span><span class="keyword">= </span><span class="string">&apos;myldap&apos;</span><span class="keyword">;<br></span><span class="default">$domain </span><span class="keyword">= </span><span class="string">&apos;mydomain.ex&apos;</span><span class="keyword">;<br></span><span class="default">$basedn </span><span class="keyword">= </span><span class="string">&apos;dc=mydomain,dc=ex&apos;</span><span class="keyword">;<br></span><span class="default">$group </span><span class="keyword">= </span><span class="string">&apos;SomeGroup&apos;</span><span class="keyword">;<br><br></span><span class="default">$ad </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="string">&quot;ldap://</span><span class="keyword">{</span><span class="default">$host</span><span class="keyword">}</span><span class="string">.</span><span class="keyword">{</span><span class="default">$domain</span><span class="keyword">}</span><span class="string">&quot;</span><span class="keyword">) or die(</span><span class="string">&apos;Could not connect to LDAP server.&apos;</span><span class="keyword">);<br></span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br></span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br>@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="string">&quot;</span><span class="keyword">{</span><span class="default">$user</span><span class="keyword">}</span><span class="string">@</span><span class="keyword">{</span><span class="default">$domain</span><span class="keyword">}</span><span class="string">&quot;</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">) or die(</span><span class="string">&apos;Could not bind to AD.&apos;</span><span class="keyword">);<br></span><span class="default">$userdn </span><span class="keyword">= </span><span class="default">getDN</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">);<br>if (</span><span class="default">checkGroupEx</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="default">getDN</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$group</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">))) {<br></span><span class="comment">//if (checkGroup($ad, $userdn, getDN($ad, $group, $basedn))) {<br>&#xA0; &#xA0; </span><span class="keyword">echo </span><span class="string">&quot;You&apos;re authorized as &quot;</span><span class="keyword">.</span><span class="default">getCN</span><span class="keyword">(</span><span class="default">$userdn</span><span class="keyword">);<br>} else {<br>&#xA0; &#xA0; echo </span><span class="string">&apos;Authorization failed&apos;</span><span class="keyword">;<br>}<br></span><span class="default">ldap_unbind</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">);<br><br></span><span class="comment">/*<br>* This function searchs in LDAP tree ($ad -LDAP link identifier)<br>* entry specified by samaccountname and returns its DN or epmty<br>* string on failure.<br>*/<br></span><span class="keyword">function </span><span class="default">getDN</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$samaccountname</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="default">$attributes </span><span class="keyword">= array(</span><span class="string">&apos;dn&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$basedn</span><span class="keyword">,<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="string">&quot;(samaccountname=</span><span class="keyword">{</span><span class="default">$samaccountname</span><span class="keyword">}</span><span class="string">)&quot;</span><span class="keyword">, </span><span class="default">$attributes</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) { return </span><span class="string">&apos;&apos;</span><span class="keyword">; }<br>&#xA0; &#xA0; </span><span class="default">$entries </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$result</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">$entries</span><span class="keyword">[</span><span class="string">&apos;count&apos;</span><span class="keyword">]&gt;</span><span class="default">0</span><span class="keyword">) { return </span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">&apos;dn&apos;</span><span class="keyword">]; }<br>&#xA0; &#xA0; else { return </span><span class="string">&apos;&apos;</span><span class="keyword">; };<br>}<br><br></span><span class="comment">/*<br>* This function retrieves and returns CN from given DN<br>*/<br></span><span class="keyword">function </span><span class="default">getCN</span><span class="keyword">(</span><span class="default">$dn</span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">&apos;/[^,]*/&apos;</span><span class="keyword">, </span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$matchs</span><span class="keyword">, </span><span class="default">PREG_OFFSET_CAPTURE</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br>&#xA0; &#xA0; return </span><span class="default">$matchs</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">];<br>}<br><br></span><span class="comment">/*<br>* This function checks group membership of the user, searching only<br>* in specified group (not recursively).<br>*/<br></span><span class="keyword">function </span><span class="default">checkGroup</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="default">$groupdn</span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="default">$attributes </span><span class="keyword">= array(</span><span class="string">&apos;members&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">ldap_read</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="string">&quot;(memberof=</span><span class="keyword">{</span><span class="default">$groupdn</span><span class="keyword">}</span><span class="string">)&quot;</span><span class="keyword">, </span><span class="default">$attributes</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) { return </span><span class="default">FALSE</span><span class="keyword">; };<br>&#xA0; &#xA0; </span><span class="default">$entries </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$result</span><span class="keyword">);<br>&#xA0; &#xA0; return (</span><span class="default">$entries</span><span class="keyword">[</span><span class="string">&apos;count&apos;</span><span class="keyword">] &gt; </span><span class="default">0</span><span class="keyword">);<br>}<br><br></span><span class="comment">/*<br>* This function checks group membership of the user, searching<br>* in specified group and groups which is its members (recursively).<br>*/<br></span><span class="keyword">function </span><span class="default">checkGroupEx</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="default">$groupdn</span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="default">$attributes </span><span class="keyword">= array(</span><span class="string">&apos;memberof&apos;</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">ldap_read</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$userdn</span><span class="keyword">, </span><span class="string">&apos;(objectclass=*)&apos;</span><span class="keyword">, </span><span class="default">$attributes</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">$result </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) { return </span><span class="default">FALSE</span><span class="keyword">; };<br>&#xA0; &#xA0; </span><span class="default">$entries </span><span class="keyword">= </span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$result</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">$entries</span><span class="keyword">[</span><span class="string">&apos;count&apos;</span><span class="keyword">] &lt;= </span><span class="default">0</span><span class="keyword">) { return </span><span class="default">FALSE</span><span class="keyword">; };<br>&#xA0; &#xA0; if (empty(</span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">&apos;memberof&apos;</span><span class="keyword">])) { return </span><span class="default">FALSE</span><span class="keyword">; } else {<br>&#xA0; &#xA0; &#xA0; &#xA0; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">&apos;memberof&apos;</span><span class="keyword">][</span><span class="string">&apos;count&apos;</span><span class="keyword">]; </span><span class="default">$i</span><span class="keyword">++) {<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; if (</span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">&apos;memberof&apos;</span><span class="keyword">][</span><span class="default">$i</span><span class="keyword">] == </span><span class="default">$groupdn</span><span class="keyword">) { return </span><span class="default">TRUE</span><span class="keyword">; }<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; elseif (</span><span class="default">checkGroupEx</span><span class="keyword">(</span><span class="default">$ad</span><span class="keyword">, </span><span class="default">$entries</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">&apos;memberof&apos;</span><span class="keyword">][</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$groupdn</span><span class="keyword">)) { return </span><span class="default">TRUE</span><span class="keyword">; };<br>&#xA0; &#xA0; &#xA0; &#xA0; };<br>&#xA0; &#xA0; };<br>&#xA0; &#xA0; return </span><span class="default">FALSE</span><span class="keyword">;<br>}<br><br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
There is a lot of confusion about accountExpires, pwdLastSet, lastLogon and badPasswordTime active directory fields.<br><br>All of them are using &quot;Interval&quot; date/time format with a value that represents the number of 100-nanosecond intervals since January 1, 1601 (UTC, and a value of 0 or 0x7FFFFFFFFFFFFFFF, 9223372036854775807, indicates that the account never expires): <a href="https://msdn.microsoft.com/en-us/library/ms675098(v=vs.85" rel="nofollow" target="_blank">https://msdn.microsoft.com/en-us/library/ms675098(v=vs.85</a>).aspx<br><br>So if you need to translate it from/to UNIX timestamp you can easily calculate the difference with:<br><br><span class="default">&lt;?php<br>$datetime1 </span><span class="keyword">= new </span><span class="default">DateTime</span><span class="keyword">(</span><span class="string">&apos;1601-01-01&apos;</span><span class="keyword">);<br></span><span class="default">$datetime2 </span><span class="keyword">= new </span><span class="default">DateTime</span><span class="keyword">(</span><span class="string">&apos;1970-01-01&apos;</span><span class="keyword">);<br></span><span class="default">$interval </span><span class="keyword">= </span><span class="default">$datetime1</span><span class="keyword">-&gt;</span><span class="default">diff</span><span class="keyword">(</span><span class="default">$datetime2</span><span class="keyword">);<br>echo (</span><span class="default">$interval</span><span class="keyword">-&gt;</span><span class="default">days </span><span class="keyword">* </span><span class="default">24 </span><span class="keyword">* </span><span class="default">60 </span><span class="keyword">* </span><span class="default">60</span><span class="keyword">) . </span><span class="string">&quot; seconds\n&quot;</span><span class="keyword">;<br></span><span class="default">?&gt;<br></span><br>The difference between both dates is 11644473600 seconds. Don&apos;t rely on floating point calculations nor other numbers that probably were calculated badly (including time zone or something similar).<br><br>Now you can convert from LDAP field:<br><br><span class="default">&lt;?php<br>$lastlogon </span><span class="keyword">= </span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">&apos;lastlogon&apos;</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">];<br></span><span class="comment">// divide by 10.000.000 to get seconds from 100-nanosecond intervals<br></span><span class="default">$winInterval </span><span class="keyword">= </span><span class="default">round</span><span class="keyword">(</span><span class="default">$lastlogon </span><span class="keyword">/ </span><span class="default">10000000</span><span class="keyword">);<br></span><span class="comment">// substract seconds from 1601-01-01 -&gt; 1970-01-01<br></span><span class="default">$unixTimestamp </span><span class="keyword">= (</span><span class="default">$winInterval </span><span class="keyword">- </span><span class="default">11644473600</span><span class="keyword">);<br></span><span class="comment">// show date/time in local time zone<br></span><span class="keyword">echo </span><span class="default">date</span><span class="keyword">(</span><span class="string">&quot;Y-m-d H:i:s&quot;</span><span class="keyword">, </span><span class="default">$unixTimestamp</span><span class="keyword">) .</span><span class="string">&quot;\n&quot;</span><span class="keyword">;<br></span><span class="default">?&gt;<br></span><br>Hope it helps.</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/ref.ldap.php)

**[To root](/README.md)**