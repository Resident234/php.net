# Connection handling




<div class="phpcode"><span class="html">
hey, thanks to arr1, and it is very useful for me, when I need to return to the user fast and then do something else.<br><br>When using the codes, it nearly drive me mad and I found another thing that may affect the codes:<br><br>Content-Encoding: gzip<br><br>This is because the zlib is on and the content will be compressed. But this will not output the buffer until all output is over.<br><br>So, it may need to send the header to prevent this problem.<br><br>now, the code becomes:<br><br><span class="default">&lt;?php<br>ob_end_clean</span><span class="keyword">();<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Connection: close\r\n&quot;</span><span class="keyword">);<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Content-Encoding: none\r\n&quot;</span><span class="keyword">);<br></span><span class="default">ignore_user_abort</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">); </span><span class="comment">// optional<br></span><span class="default">ob_start</span><span class="keyword">();<br>echo (</span><span class="string">&apos;Text user will see&apos;</span><span class="keyword">);<br></span><span class="default">$size </span><span class="keyword">= </span><span class="default">ob_get_length</span><span class="keyword">();<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Content-Length: </span><span class="default">$size</span><span class="string">&quot;</span><span class="keyword">);<br></span><span class="default">ob_end_flush</span><span class="keyword">();&#xA0; &#xA0;&#xA0; </span><span class="comment">// Strange behaviour, will not work<br></span><span class="default">flush</span><span class="keyword">();&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// Unless both are called !<br></span><span class="default">ob_end_clean</span><span class="keyword">();<br><br></span><span class="comment">//do processing here<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br><br>echo(</span><span class="string">&apos;Text user will never see&apos;</span><span class="keyword">);<br></span><span class="comment">//do some processing<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
Closing the users browser connection whilst keeping your php script running has been an issue since 4.1, when the behaviour of register_shutdown_function() was modified so that it would not automatically close the users connection.<br><br>sts at mail dot xubion dot hu<br>Posted the original solution:<br><br><span class="default">&lt;?php<br>header</span><span class="keyword">(</span><span class="string">&quot;Connection: close&quot;</span><span class="keyword">);<br></span><span class="default">ob_start</span><span class="keyword">();<br></span><span class="default">phpinfo</span><span class="keyword">();<br></span><span class="default">$size</span><span class="keyword">=</span><span class="default">ob_get_length</span><span class="keyword">();<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Content-Length: </span><span class="default">$size</span><span class="string">&quot;</span><span class="keyword">);<br></span><span class="default">ob_end_flush</span><span class="keyword">();<br></span><span class="default">flush</span><span class="keyword">();<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">13</span><span class="keyword">);<br></span><span class="default">error_log</span><span class="keyword">(</span><span class="string">&quot;do something in the background&quot;</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>Which works fine until you substitute phpinfo() for <br>echo (&apos;text I want user to see&apos;); in which case the headers are never sent!<br><br>The solution is to explicitly turn off output buffering and clear the buffer prior to sending your header information.<br><br>example:<br><br><span class="default">&lt;?php<br> ob_end_clean</span><span class="keyword">();<br> </span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Connection: close&quot;</span><span class="keyword">);<br> </span><span class="default">ignore_user_abort</span><span class="keyword">(); </span><span class="comment">// optional<br> </span><span class="default">ob_start</span><span class="keyword">();<br> echo (</span><span class="string">&apos;Text the user will see&apos;</span><span class="keyword">);<br> </span><span class="default">$size </span><span class="keyword">= </span><span class="default">ob_get_length</span><span class="keyword">();<br> </span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Content-Length: </span><span class="default">$size</span><span class="string">&quot;</span><span class="keyword">);<br> </span><span class="default">ob_end_flush</span><span class="keyword">(); </span><span class="comment">// Strange behaviour, will not work<br> </span><span class="default">flush</span><span class="keyword">();&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// Unless both are called !<br> // Do processing here <br> </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">30</span><span class="keyword">);<br> echo(</span><span class="string">&apos;Text user will never see&apos;</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span> <br>Just spent 3 hours trying to figure this one out, hope it helps someone :)<br><br>Tested in:<br>IE 7.5730.11<br>Mozilla Firefox 1.81</span>
</div>
  

#


<div class="phpcode"><span class="html">
I had a lot of problems getting a redirect to work, after which my script was intended to keep working in the background. The redirect to another page of my site simply would only work once the original page had finished processing.<br><br>I finally found out what was wrong:<br>The session only gets closed by PHP at the very end of the script, and since access to the session data is locked to prevent more than one page writing to it simultaneously, the new page cannot load until the original processing has finished.<br><br>Solution:<br>Close the session manually when redirecting using session_write_close():<br><br><span class="default">&lt;?php<br>ignore_user_abort</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);<br></span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br><br></span><span class="default">$strURL </span><span class="keyword">= </span><span class="string">&quot;PUT YOUR REDIRCT HERE&quot;</span><span class="keyword">;<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Location: </span><span class="default">$strURL</span><span class="string">&quot;</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Connection: close&quot;</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Content-Encoding: none\r\n&quot;</span><span class="keyword">);<br></span><span class="default">header</span><span class="keyword">(</span><span class="string">&quot;Content-Length: 0&quot;</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br><br></span><span class="default">flush</span><span class="keyword">();<br></span><span class="default">ob_flush</span><span class="keyword">();<br><br></span><span class="default">session_write_close</span><span class="keyword">();<br><br></span><span class="comment">// Continue processing...<br><br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">100</span><span class="keyword">);<br>exit;<br></span><span class="default">?&gt;<br></span><br>But careful:<br>Make sure that your script doesn&apos;t write to the session after session_write_close(), i.e. in your background processing code.&#xA0; That won&apos;t work.&#xA0; Also avoid reading, remember, the next script may already have modified the data.<br><br>So try to read out the data you need prior to redirecting.</span>
</div>
  

#


<div class="phpcode"><span class="html">
PHP changes directory on connection abort so code like this will not do what you want:<br><br><span class="default">&lt;?php<br></span><span class="keyword">function </span><span class="default">abort</span><span class="keyword">()<br>{<br>&#xA0; &#xA0;&#xA0; if(</span><span class="default">connection_aborted</span><span class="keyword">())<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">&apos;file.ini&apos;</span><span class="keyword">);<br>}<br></span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">&apos;abort&apos;</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>actually it will delete file in apaches&apos;s root dir so if you want to unlink file in your script&apos;s dir on abort or write to it you have to store directory<br><span class="default">&lt;?php<br></span><span class="keyword">function </span><span class="default">abort</span><span class="keyword">()<br>{<br>&#xA0; &#xA0;&#xA0; global </span><span class="default">$dsd</span><span class="keyword">;<br>&#xA0; &#xA0;&#xA0; if(</span><span class="default">connection_aborted</span><span class="keyword">())<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;&#xA0; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$dsd</span><span class="keyword">.</span><span class="string">&apos;/file.ini&apos;</span><span class="keyword">);<br>}<br></span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">&apos;abort&apos;</span><span class="keyword">);<br></span><span class="default">$dsd</span><span class="keyword">=</span><span class="default">getcwd</span><span class="keyword">();<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#


<div class="phpcode"><span class="html">
The point mentioned in the last comment isn&apos;t always the case.<br><br>If a user&apos;s connection is lost half way through an order processing script is confirming a user&apos;s credit card/adding them to a DB, etc (due to their ISP going down, network trouble... whatever) and your script tries to send back output (such as, &quot;pre-processing order&quot; or any other type of confirmation), then your script will abort -- and this could cause problems for your process.<br><br>I have an order script that adds data to a InnoDB database (through MySQL) and only commits the transactions upon successful completion. Without ignore_user_abort(), I have had times when a user&apos;s connection dropped during the processing phase... and their card was charged, but they weren&apos;t added to my local DB.<br><br>So, it&apos;s always safe to ignore any aborts if you are processing sensitive transactions that should go ahead, whether your user is &quot;watching&quot; on the other end or not.</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/features.connection-handling.php)

**[To root](/)**