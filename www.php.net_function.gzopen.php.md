# gzopen




<div class="phpcode"><span class="html">
gzopen(&quot;php://output&quot;,&quot;wb&quot;) doesn&apos;t work on a web server, nor does fopen(&quot;compress.zlib://php://output&quot;,&quot;wb&quot;).<br><br>Here is a snippet to gzip a file and output it on the fly, without using a temporary file, without reading the file into memory, and without reading the file more than once:<br><br><span class="default">&lt;?php<br>$fin </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">, </span><span class="string">&quot;rb&quot;</span><span class="keyword">);<br>if (</span><span class="default">$fin </span><span class="keyword">!== </span><span class="default">FALSE</span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="default">$fout </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">&quot;php://output&quot;</span><span class="keyword">, </span><span class="string">&quot;wb&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; if (</span><span class="default">$fout </span><span class="keyword">!== </span><span class="default">FALSE</span><span class="keyword">) {<br>&#xA0; &#xA0; </span><span class="comment">// write gzip header<br>&#xA0; &#xA0; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">, </span><span class="string">&quot;\x1F\x8B\x08\x08&quot;</span><span class="keyword">.</span><span class="default">pack</span><span class="keyword">(</span><span class="string">&quot;V&quot;</span><span class="keyword">, </span><span class="default">filemtime</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)).</span><span class="string">&quot;\0\xFF&quot;</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="comment">// write the original file name<br>&#xA0; &#xA0; </span><span class="default">$oname </span><span class="keyword">= </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">&quot;\0&quot;</span><span class="keyword">, </span><span class="string">&quot;&quot;</span><span class="keyword">, </span><span class="default">basename</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">));<br>&#xA0; &#xA0; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">, </span><span class="default">$oname</span><span class="keyword">.</span><span class="string">&quot;\0&quot;</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">+</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$oname</span><span class="keyword">));<br>&#xA0; &#xA0; </span><span class="comment">// add the deflate filter using default compression level<br>&#xA0; &#xA0; </span><span class="default">$fltr </span><span class="keyword">= </span><span class="default">stream_filter_append</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">, </span><span class="string">&quot;zlib.deflate&quot;</span><span class="keyword">, </span><span class="default">STREAM_FILTER_WRITE</span><span class="keyword">, -</span><span class="default">1</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="comment">// set up the CRC32 hashing context<br>&#xA0; &#xA0; </span><span class="default">$hctx </span><span class="keyword">= </span><span class="default">hash_init</span><span class="keyword">(</span><span class="string">&quot;crc32b&quot;</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="comment">// turn off the time limit<br>&#xA0; &#xA0; </span><span class="keyword">if (!</span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">&quot;safe_mode&quot;</span><span class="keyword">)) </span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">$con </span><span class="keyword">= </span><span class="default">TRUE</span><span class="keyword">;<br>&#xA0; &#xA0; </span><span class="default">$fsize </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&#xA0; &#xA0; while ((</span><span class="default">$con </span><span class="keyword">!== </span><span class="default">FALSE</span><span class="keyword">) &amp;&amp; !</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fin</span><span class="keyword">)) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="comment">// deflate works best with buffers &gt;32K<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$con </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fin</span><span class="keyword">, </span><span class="default">64 </span><span class="keyword">* </span><span class="default">1024</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; if (</span><span class="default">$con </span><span class="keyword">!== </span><span class="default">FALSE</span><span class="keyword">) {<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">hash_update</span><span class="keyword">(</span><span class="default">$hctx</span><span class="keyword">, </span><span class="default">$con</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$clen </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$con</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">$fsize </span><span class="keyword">+= </span><span class="default">$clen</span><span class="keyword">;<br>&#xA0; &#xA0; &#xA0; &#xA0; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">, </span><span class="default">$con</span><span class="keyword">, </span><span class="default">$clen</span><span class="keyword">);<br>&#xA0; &#xA0; &#xA0; &#xA0; }<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; </span><span class="comment">// remove the deflate filter<br>&#xA0; &#xA0; </span><span class="default">stream_filter_remove</span><span class="keyword">(</span><span class="default">$fltr</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="comment">// write the CRC32 value<br>&#xA0; &#xA0; // hash_final is a string, not an integer<br>&#xA0; &#xA0; </span><span class="default">$crc </span><span class="keyword">= </span><span class="default">hash_final</span><span class="keyword">(</span><span class="default">$hctx</span><span class="keyword">, </span><span class="default">TRUE</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="comment">// need to reverse the hash_final string so it&apos;s little endian<br>&#xA0; &#xA0; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">, </span><span class="default">$crc</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">].</span><span class="default">$crc</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">].</span><span class="default">$crc</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">].</span><span class="default">$crc</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">4</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="comment">// write the original uncompressed file size<br>&#xA0; &#xA0; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">, </span><span class="default">pack</span><span class="keyword">(</span><span class="string">&quot;V&quot;</span><span class="keyword">, </span><span class="default">$fsize</span><span class="keyword">), </span><span class="default">4</span><span class="keyword">);<br>&#xA0; &#xA0; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fout</span><span class="keyword">);<br>&#xA0; &#xA0; }<br>&#xA0; &#xA0; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fin</span><span class="keyword">);<br>}<br></span><span class="default">?&gt;</span>
</span>
</div>
  

#

[Official documentation page](https://www.php.net/manual/en/function.gzopen.php)

**[â¬† to root](/)**